<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunForCan - Sepet</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* CSS AYNI KALIYOR - DEÄžÄ°ÅžÄ°KLÄ°K YOK */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Arial, sans-serif; background: #f4f6f9; user-select: none; -webkit-user-select: none; overflow-x: hidden; }
        header { position: fixed; top: 0; left: 0; width: 100%; background: #111827; color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; font-weight: bold; }
        header .active, #count { background: #2563eb; padding: 4px 10px; border-radius: 20px; font-size: 13px; }
        #content { padding: 70px 10px 20px; }
        .container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .card { background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 230px; object-fit: cover; }
        .card-content { padding: 10px; flex-grow: 1; }
        .brand { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .desc { font-size: 12px; color: #374151; height: 50px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; margin-bottom: 5px; }
        .info { font-size: 11px; color: #6b7280; margin-bottom: 2px; }
        .timer-container { margin-top: 8px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #34d399, #2563eb); width: 100%; transition: width 0.5s; }
        .timer-text { font-size: 10px; font-weight: bold; color: #4b5563; margin-top: 3px; }
        .button-group { display: flex; flex-direction: column; gap: 4px; padding: 10px; }
        .btn-row { display: flex; gap: 4px; }
        .button-group button { flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 11px; font-weight: bold; background: #2563eb; color: white; cursor: pointer; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; }
        .close-btn { margin-top: 15px; padding: 10px 20px; background: #111827; color: white; border: none; border-radius: 6px; width: 100%; }
		/* BoÅŸ Sepet MesajÄ± Stili */
.empty-basket {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    margin-top: 100px;
    padding: 20px;
}

.empty-basket h2 {
    color: #4b5563;
    font-size: 18px;
    margin-bottom: 10px;
}

.empty-basket .icon {
    font-size: 50px;
    margin-bottom: 15px;
}
    </style>
</head>
<body>

<header>
    <span onclick="location.href='anasayfa.html'" style="cursor:pointer;">Anasayfa</span>
    <span class="active">Sepet</span>
    <span onclick="location.href='mesaj.html'" style="cursor:pointer;">Mesajlar</span>
    <span id="count" onclick="clearBasket()" style="cursor:pointer; background: #ef4444;">0</span>
</header>

<div id="content"></div>

<div id="mainModal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
        <h2 id="modalTitle" style="font-size: 16px;"></h2>
        <div id="modalBody"></div>
        <button class="close-btn" onclick="closeModal()">Kapat</button>
    </div>
</div>

<script>
async function clearBasket() {
    const user = localStorage.getItem("user");
    if (!user) return;

    // KullanÄ±cÄ±ya onay soralÄ±m (YanlÄ±ÅŸlÄ±kla tÄ±klamalara karÅŸÄ±)
    const onay = confirm("Sepetinizdeki tÃ¼m Ã¼rÃ¼nler silinecektir. Emin misiniz?");
    
    if (onay) {
        try {
            // Firebase'deki o kullanÄ±cÄ±ya ait sepeti siliyoruz (DELETE metoduyla)
            const res = await fetch(`https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app/basketData/${user}.json`, {
                method: "DELETE"
            });

            if (res.ok) {
                alert("Sepet baÅŸarÄ±yla temizlendi.");
                // SayfayÄ± yenileyerek boÅŸ sepet mesajÄ±nÄ±n gelmesini saÄŸlÄ±yoruz
                loadData(); 
            } else {
                alert("Sepet temizlenirken bir sorun oluÅŸtu.");
            }
        } catch (e) {
            console.error(e);
            alert("BaÄŸlantÄ± hatasÄ±.");
        }
    }
}
const contentDiv = document.getElementById("content");

// SayaÃ§ GÃ¼ncelleme
setInterval(() => {
    document.querySelectorAll('.timer-data').forEach(el => {
        const deadline = new Date(el.dataset.startdate).getTime() + (12 * 60 * 60 * 1000);
        const timeLeft = deadline - new Date().getTime();
        const fill = el.querySelector('.progress-bar-fill');
        const text = el.querySelector('.time-left-text');
        if (timeLeft <= 0) {
            fill.style.width = "0%"; fill.style.background = "#ef4444";
            text.innerText = "SÃ¼re Doldu!";
        } else {
            const perc = (timeLeft / (12 * 60 * 60 * 1000)) * 100;
            fill.style.width = perc + "%";
            const h = Math.floor(timeLeft / 3600000), m = Math.floor((timeLeft % 3600000) / 60000), s = Math.floor((timeLeft % 60000) / 1000);
            text.innerText = `Kalan: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            fill.style.background = timeLeft < 3600000 ? (timeLeft < 900000 ? "#ef4444" : "#f59e0b") : "linear-gradient(90deg, #34d399, #2563eb)";
        }
    });
}, 1000);

// MODAL YÃ–NETÄ°MÄ° (Barkod hatasÄ±nÄ± Ã§Ã¶zen kÄ±sÄ±m)
function openModal(title, contentHTML, isBarcode = false, ean = "") {
    document.getElementById("modalTitle").innerText = title;
    const body = document.getElementById("modalBody");
    body.innerHTML = isBarcode ? '<svg id="barcodeCanvas"></svg>' : contentHTML;
    document.getElementById("mainModal").style.display = "flex";

    // Barkodun Ã§izilmesi iÃ§in modalÄ±n ekranda gÃ¶rÃ¼nÃ¼r olmasÄ±nÄ± beklemeliyiz
    if(isBarcode && ean) {
        setTimeout(() => {
            try {
                JsBarcode("#barcodeCanvas", ean, { format: "CODE128", width: 2, height: 80, displayValue: true });
            } catch (e) {
                body.innerHTML = "Barkod hatasÄ±: " + ean;
            }
        }, 100); // 100ms gecikme SVG'nin DOM'a iÅŸlenmesi iÃ§in yeterli
    }
}

const closeModal = () => document.getElementById("mainModal").style.display = "none";

// --- YENÄ° EKLENEN SECTION ARAMA FONKSÄ°YONU ---
async function findSectionInfo(orderProductId) {
    const modalBody = document.getElementById("modalBody");
    modalBody.innerHTML = "VeritabanÄ±nda aranÄ±yor...";

    // ID'yi temizleyelim (varsa saÄŸÄ±ndaki solundaki boÅŸluklarÄ± atalÄ±m)
    const targetId = orderProductId.trim();

    try {
        const response = await fetch('section.txt');
        if (!response.ok) throw new Error("Dosya bulunamadÄ±");
        
        const text = await response.text();
        // SatÄ±rlarÄ± ayÄ±r ve her satÄ±rÄ± temizle
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");

        // EÅŸleÅŸen satÄ±rlarÄ± bul (Sadece ilk sÃ¼tun tam eÅŸleÅŸirse)
        const matches = lines.filter(line => {
            const columns = line.split('\t'); // Tab ile ayrÄ±ldÄ±ÄŸÄ±nÄ± varsayÄ±yoruz
            return columns[0].trim() === targetId; 
        });

        if (matches.length > 0) {
            let tableHTML = `
                <table style="width:100%; border-collapse: collapse; font-size: 12px; margin-top: 10px;">
                    <thead style="background: #f3f4f6;">
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px;">DEPO</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">SECTION</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">ADET</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            matches.forEach(match => {
                const columns = match.split('\t'); 
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${columns[3] || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-weight:bold; color:#2563eb;">${columns[4] || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${columns[5] || '-'}</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            modalBody.innerHTML = tableHTML;
        } else {
            modalBody.innerHTML = `<div style='color:red; padding:20px;'>Section bilgisi mevcut deÄŸil!<br><small>(Aranan: ${targetId})</small></div>`;
        }
    } catch (error) {
        modalBody.innerHTML = "Dosya okuma hatasÄ±: section.txt bulunamadÄ± veya eriÅŸilemedi.";
    }
}
async function findMovementInfo(orderProductId) {
    const modalBody = document.getElementById("modalBody");
    modalBody.innerHTML = "Hareketler yÃ¼kleniyor...";

    const targetId = orderProductId.trim();

    try {
        const response = await fetch('hareket.txt');
        if (!response.ok) throw new Error("Dosya bulunamadÄ±");
        
        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");

        const matches = lines.filter(line => {
            const columns = line.split('\t');
            return columns[0] && columns[0].trim() === targetId; 
        });

        if (matches.length > 0) {
            let totalSum = 0; // ToplamÄ± tutacak deÄŸiÅŸken
            
            let tableHTML = `
                <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse: collapse; font-size: 10px; margin-top: 10px;">
                    <thead style="background: #f3f4f6;">
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 6px;">DEPO</th>
                            <th style="border: 1px solid #ddd; padding: 6px;">KOD</th>
                            <th style="border: 1px solid #ddd; padding: 6px;">ADET</th>
                            <th style="border: 1px solid #ddd; padding: 6px;">TARÄ°H</th>
                            <th style="border: 1px solid #ddd; padding: 6px;">AÃ‡IKLAMA</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            matches.forEach(match => {
                const columns = match.split('\t');
                // S3 sÃ¼tunundaki (indis 2) deÄŸerleri topluyoruz. 
                // SayÄ± deÄŸilse (boÅŸsa veya metinse) 0 sayÄ±yoruz.
                const val = parseFloat(columns[3]) || 0;
                totalSum += val;

                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 6px;">${columns[1] || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${columns[2] || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; font-weight:bold;">${columns[3] || '-'}</td>						
                        <td style="border: 1px solid #ddd; padding: 6px;">${columns[4] || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${columns[5] || '-'}</td>
                    </tr>`;
            });

            // Toplam SatÄ±rÄ±
            tableHTML += `
                    <tr style="background: #f9fafb; font-weight: bold;">
                        <td style="border: 1px solid #ddd; padding: 6px; text-align:right;">TOPLAM:</td>
                        <td colspan="1" style="border: 1px solid #ddd; padding: 6px; background: #eee;"></td>
                        <td style="border: 1px solid #ddd; padding: 6px; color: #2563eb;">${totalSum}</td>
                        <td colspan="3" style="border: 1px solid #ddd; padding: 6px; background: #eee;"></td>
                    </tr>`;

            tableHTML += `</tbody></table></div>`;
            modalBody.innerHTML = tableHTML;
        } else {
            modalBody.innerHTML = `<div style='color:red; padding:20px;'>Hareket kaydÄ± bulunamadÄ±!</div>`;
        }
    } catch (error) {
        modalBody.innerHTML = "Dosya hatasÄ±: hareket.txt okunamadÄ±.";
    }
}

async function loadData() {
    const user = localStorage.getItem("user");
    if (!user) return location.href = "anasayfa.html";
    
    try {
        const res = await fetch("https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app/basketData.json");
        const data = await res.json();
        
        // KullanÄ±cÄ±ya ait veri var mÄ± yok mu kontrolÃ¼
        const items = (data && data[user]) ? data[user] : [];
        
        document.getElementById("count").innerText = items.length + " Ã¼rÃ¼n";

        // EÄŸer Ã¼rÃ¼n sayÄ±sÄ± 0 ise mesajÄ± gÃ¶ster
        if (items.length === 0) {
            contentDiv.innerHTML = `
                <div class="empty-basket">
                    <div class="icon">ðŸ›’</div>
                    <h2>Sepetinizde Ã¼rÃ¼n bulunmamaktadÄ±r. :(</h2>
                    <p style="color: #6b7280; font-size: 14px;">Ansayfaya dÃ¶nÃ¼p talep durumunu gÃ¶rÃ¼ntÃ¼leyebilir ya da Mesajlar kÄ±smÄ±ndan talep yok diyerek aÄŸlayabilirsiniz.</p>
                    <button onclick="location.href='mesaj.html'" style="margin-top:20px; padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                        Mesajlar
                    </button>
                </div>`;
            return;
        }

        // ÃœrÃ¼n varsa kartlarÄ± oluÅŸtur
        contentDiv.innerHTML = `<div class="container">${items.map(p => {
            const safeDesc = p.description.replace(/'/g, "\\'");
            return `
<div class="card" onclick="handleDoubleClick('${p.orderProductId}')">
    <img src="${p.imageUrl.replace(/\/mnresize\/\d+\/\d+\//, "/mnresize/784/1080/")}" alt="">
    <div class="card-content">
        <div class="brand">${p.brand}</div>
        <div class="desc">${p.description}</div>
        <div class="info">Beden: ${p.size} | Renk: ${p.color}</div>
        <div class="info">${p.ean || '-'}  ${p.orderProductId || '-'}</div>
        <div class="timer-container timer-data" data-startdate="${p.date}">
            <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
            <div class="timer-text"><span class="time-left-text">...</span></div>
        </div>
    </div>
    <div class="button-group">
        <button onclick="event.stopPropagation(); shareProduct(${JSON.stringify(p).replace(/"/g, '&quot;')})" 
                style="background:#10b981; margin-bottom:4px; width:100%;">
            ðŸ“¢ YARDIM Ä°STE!
        </button>
        <div class="btn-row">
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Stok Bilgisi YÃ¼kleniyor...')">STOK</button>
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'YÃ¼kleniyor...'); findMovementInfo('${p.orderProductId}')">HAREKET</button>
        </div>
        <div class="btn-row">
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', '', true, '${p.ean}')">BARKOD</button>
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'YÃ¼kleniyor...'); findSectionInfo('${p.orderProductId}')">SECTION</button>
        </div>
    </div>
</div>`;
        }).join('')}</div>`;
    } catch (e) { 
        contentDiv.innerHTML = "<div class='error' style='text-align:center; margin-top:50px;'>VeritabanÄ± baÄŸlantÄ± hatasÄ± oluÅŸtu.</div>"; 
    }
}

let lastClick = 0;
function handleDoubleClick(id) {
    const now = Date.now();
    if (now - lastClick < 400) window.open("https://www.boyner.com.tr/search?q=" + id.slice(0, -3), "_blank");
    lastClick = now;
}

loadData();
document.addEventListener("contextmenu", e => e.preventDefault());
async function shareProduct(product) {
    const user = localStorage.getItem("user");

    const shareData = {
        user: user,
        text: "Bir Ã¼rÃ¼n paylaÅŸtÄ±!",
        product: product, // ÃœrÃ¼n verilerini aynen gÃ¶nderiyoruz
        type: "product_share",
        timestamp: Date.now()
    };

    try {
        await fetch("https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app/messages.json", {
            method: "POST",
            body: JSON.stringify(shareData)
        });
        alert("ÃœrÃ¼n baÅŸarÄ±yla paylaÅŸÄ±ldÄ±!");
    } catch (e) {
        alert("PaylaÅŸÄ±m baÅŸarÄ±sÄ±z.");
    }
}
</script>

</body>
</html>