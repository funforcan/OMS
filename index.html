<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunForCan - Sepet</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* CSS AYNI KALIYOR */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Arial, sans-serif; background: #f4f6f9; user-select: none; -webkit-user-select: none; overflow-x: hidden; }
        header { position: fixed; top: 0; left: 0; width: 100%; background: #111827; color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; font-weight: bold; }
        header .active, #count { background: #2563eb; padding: 4px 10px; border-radius: 20px; font-size: 13px; }
        #content { padding: 70px 10px 20px; min-height: 100vh; }
        .container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .card { background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 230px; object-fit: cover; }
        .card-content { padding: 10px; flex-grow: 1; }
        .brand { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .desc { font-size: 12px; color: #374151; height: 50px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; margin-bottom: 5px; }
        .info { font-size: 11px; color: #6b7280; margin-bottom: 2px; }
        .timer-container { margin-top: 8px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #34d399, #2563eb); width: 100%; transition: width 0.5s; }
        .timer-text { font-size: 10px; font-weight: bold; color: #4b5563; margin-top: 3px; }
        .button-group { display: flex; flex-direction: column; gap: 4px; padding: 10px; }
        .btn-row { display: flex; gap: 4px; }
        .button-group button { flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 11px; font-weight: bold; background: #2563eb; color: white; cursor: pointer; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; }
        .close-btn { margin-top: 15px; padding: 10px 20px; background: #111827; color: white; border: none; border-radius: 6px; width: 100%; }

        /* Loader'ƒ± Ortalamak ƒ∞√ßin Stil */
        .loader-wrapper {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1500;
        }

        .loader {
          width: 50px;
          aspect-ratio: 1;
          --_c:no-repeat radial-gradient(farthest-side,#2563eb 92%,#0000);
          background: 
            var(--_c) top,
            var(--_c) left,
            var(--_c) right,
            var(--_c) bottom;
          background-size: 12px 12px;
          animation: l7 1s infinite;
        }
        @keyframes l7 {to{transform: rotate(.5turn)}}

        .empty-basket {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-top: 100px;
            padding: 20px;
        }
        .empty-basket h2 { color: #4b5563; font-size: 18px; margin-bottom: 10px; }
        .empty-basket .icon { font-size: 50px; margin-bottom: 15px; }
    </style>
</head>
<body>

<header>
    <span onclick="location.href='anasayfa.html'" style="cursor:pointer;">Anasayfa</span>
    <span class="active" onclick="toggleUserSelector()" style="cursor:pointer; display: flex; align-items: center; gap: 5px;">
        Sepet <small id="plus-icon" style="font-size: 16px; font-weight: bold;">+</small>
    </span>
    <span onclick="location.href='mesaj.html'" style="cursor:pointer;">Mesajlar</span>
    <span id="count" style="background: #2563eb;">0</span>
</header>

<div id="user-selector-container" style="display: none; position: fixed; top: 50px; left: 0; width: 100%; background: #111827; padding: 10px; z-index: 999; border-bottom: 2px solid #2563eb; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
    <select id="userDropdown" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white; font-size: 14px; outline: none; appearance: none; cursor: pointer;">
        <option value="">üîç Bir Kullanƒ±cƒ± Se√ßin...</option>
    </select>
</div>
<div id="content">
    <div id="loaderArea" class="loader-wrapper">
        <div class="loader"></div>
        <p style="margin-top:10px; font-size:12px; color:#6b7280;">Sepet g√ºncelleniyor...</p>
    </div>
</div>
<div id="mainModal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
        <h2 id="modalTitle" style="font-size: 16px;"></h2>
        <div id="modalBody"></div>
        <button class="close-btn" onclick="closeModal()">Kapat</button>
    </div>
</div>
<script>
const baseDbUrl = "https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app";
const contentDiv = document.getElementById("content");
let currentTargetUserId = localStorage.getItem("user");
// 1. CLEAR BASKET FONKSƒ∞YONU
async function clearBasket() {
    const userId = localStorage.getItem("user");
    if (!userId) return;

    try {
        await fetch(`${baseDbUrl}/basketData/${userId}.json`, { method: 'DELETE' });
        await fetch(`${baseDbUrl}/UserList/${userId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ refresh: true })
        });
        console.log("Sƒ±fƒ±rlama talebi g√∂nderildi.");
    } catch (err) {
        console.error("Sƒ±fƒ±rlama hatasƒ±:", err);
    }
}
async function loadUserDropdown() {
    const dropdown = document.getElementById("userDropdown");
    try {
        const res = await fetch(`${baseDbUrl}/UserList.json`);
        const users = await res.json();
        
        for (let userId in users) {
            const option = document.createElement("option");
            option.value = userId;
            option.textContent = users[userId].userTitle || userId; // Title yoksa ID yaz
            dropdown.appendChild(option);
        }
    } catch (e) {
        console.error("Kullanƒ±cƒ± listesi alƒ±namadƒ±:", e);
    }
}

// 2. Dropdown Deƒüi≈ütiƒüinde √áalƒ±≈üacak Olay
document.getElementById("userDropdown").addEventListener("change", async (e) => {
    const selectedUserId = e.target.value;
    if (!selectedUserId) return;

    currentTargetUserId = selectedUserId; // Hedef kullanƒ±cƒ±yƒ± g√ºncelle
    
    // Loader'ƒ± g√∂ster
    contentDiv.innerHTML = `
        <div id="loaderArea" class="loader-wrapper">
            <div class="loader"></div>
            <p style="margin-top:10px; font-size:12px; color:#6b7280;">${e.target.options[e.target.selectedIndex].text} sepeti √ßekiliyor...</p>
        </div>`;

    try {
        // Se√ßilen ki≈üinin refresh'ini true yap
        await fetch(`${baseDbUrl}/UserList/${selectedUserId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ refresh: true })
        });

        // Se√ßilen ki≈üinin basketData'sƒ±nƒ± temizle (Sizin clearBasket mantƒ±ƒüƒ±nƒ±z)
        await fetch(`${baseDbUrl}/basketData/${selectedUserId}.json`, { method: 'DELETE' });

        // Veri beklemeyi ba≈ülat
        waitForData(selectedUserId);
        
    } catch (err) {
        console.error("Hata:", err);
    }
});
function toggleUserSelector() {
    const container = document.getElementById("user-selector-container");
    const icon = document.getElementById("plus-icon");
    if (container.style.display === "none") {
        container.style.display = "block";
        icon.innerText = "‚àí"; // A√ßƒ±lƒ±nca eksi olsun
    } else {
        container.style.display = "none";
        icon.innerText = "+"; // Kapanƒ±nca artƒ± olsun
    }
}

// Dropdown se√ßiminden sonra otomatik kapatma ekleyelim
document.getElementById("userDropdown").addEventListener("change", async (e) => {
    const selectedUserId = e.target.value;
    if (!selectedUserId) return;

    // Se√ßim yapƒ±lƒ±nca paneli kapat
    toggleUserSelector();

    currentTargetUserId = selectedUserId;
    
    contentDiv.innerHTML = `
        <div id="loaderArea" class="loader-wrapper">
            <div class="loader"></div>
            <p style="margin-top:10px; font-size:12px; color:#6b7280;">${e.target.options[e.target.selectedIndex].text} sepeti √ßekiliyor...</p>
        </div>`;

    try {
        await fetch(`${baseDbUrl}/UserList/${selectedUserId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ refresh: true })
        });
        await fetch(`${baseDbUrl}/basketData/${selectedUserId}.json`, { method: 'DELETE' });
        waitForData(selectedUserId);
    } catch (err) {
        console.error("Hata:", err);
    }
});
function waitForData(userId) {
    let dataReceived = false;
    
    const timeout = setTimeout(() => {
        if (!dataReceived) {
            clearInterval(checkInterval);
            showEmptyBasket();
        }
    }, 5000);

    const checkInterval = setInterval(async () => {
        const items = await fetchBasketItems(userId);
        if (items && items.length > 0) {
            dataReceived = true;
            clearInterval(checkInterval);
            clearTimeout(timeout);
            renderBasket(items);
        }
    }, 1500);
}
async function startApp() {
    const userId = localStorage.getItem("user");
    if (!userId) return location.href = "anasayfa.html";
    
    await loadUserDropdown();
    
    // Sayfa ilk a√ßƒ±ldƒ±ƒüƒ±nda kendi sepetimizi √ßekelim
    waitForData(userId);
    // Kendi refreshimizi de tetikleyelim
    await fetch(`${baseDbUrl}/UserList/${userId}.json`, {
        method: 'PATCH',
        body: JSON.stringify({ refresh: true })
    });
}

async function fetchBasketItems(userId) {
    try {
        const res = await fetch(`${baseDbUrl}/basketData/${userId}.json`);
        const data = await res.json();
        return data || [];
    } catch (e) {
        return [];
    }
}

function renderBasket(items) {
    document.getElementById("count").innerText = items.length + " √ºr√ºn";
    contentDiv.innerHTML = `<div class="container">${items.map(p => {
        const safeDesc = p.description.replace(/'/g, "\\'");
        return `
<div class="card" onclick="handleDoubleClick('${p.orderProductId}')">
    <img src="${p.imageUrl.replace(/\/mnresize\/\d+\/\d+\//, "/mnresize/784/1080/")}" alt="">
    <div class="card-content">
        <div class="brand">${p.brand}</div>
        <div class="desc">${p.description}</div>
        <div class="info">Beden: ${p.size} | Renk: ${p.color}</div>
        <div class="info">${p.ean || '-'}  ${p.orderProductId || '-'}</div>
        <div class="timer-container timer-data" data-startdate="${p.date}">
            <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
            <div class="timer-text"><span class="time-left-text">...</span></div>
        </div>
    </div>
    <div class="button-group">
        <button onclick="event.stopPropagation(); shareProduct(${JSON.stringify(p).replace(/"/g, '&quot;')})" style="background:#10b981; margin-bottom:4px; width:100%;">üì¢ YARDIM ƒ∞STE!</button>
        <div class="btn-row">
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Stok Bilgisi Y√ºkleniyor...')">STOK</button>
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Y√ºkleniyor...'); findMovementInfo('${p.orderProductId}')">HAREKET</button>
        </div>
        <div class="btn-row">
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', '', true, '${p.ean}')">BARKOD</button>
            <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Y√ºkleniyor...'); findSectionInfo('${p.orderProductId}')">SECTION</button>
        </div>
    </div>
</div>`;
    }).join('')}</div>`;
}

function showEmptyBasket() {
    document.getElementById("count").innerText = "0 √ºr√ºn";
    contentDiv.innerHTML = `
        <div class="empty-basket">
            <div class="icon">üõí</div>
            <h2>Sepetinizde √ºr√ºn bulunmamaktadƒ±r. :(</h2>
            <p style="color: #6b7280; font-size: 14px;">Ansayfaya d√∂n√ºp talep durumunu g√∂r√ºnt√ºleyebilir ya da Mesajlar kƒ±smƒ±ndan talep yok diyerek aƒülayabilirsiniz.</p>
            <button onclick="location.href='mesaj.html'" style="margin-top:20px; padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                Mesajlar
            </button>
        </div>`;
}

// Sayfa y√ºklendiƒüinde ba≈ülat
startApp();

// --- Dƒ∞ƒûER FONKSƒ∞YONLAR (Modal, Barcode, etc. aynen kalƒ±yor) ---

setInterval(() => {
    document.querySelectorAll('.timer-data').forEach(el => {
        const deadline = new Date(el.dataset.startdate).getTime() + (12 * 60 * 60 * 1000);
        const timeLeft = deadline - new Date().getTime();
        const fill = el.querySelector('.progress-bar-fill');
        const text = el.querySelector('.time-left-text');
        if (timeLeft <= 0) {
            fill.style.width = "0%"; fill.style.background = "#ef4444";
            text.innerText = "S√ºre Doldu!";
        } else {
            const perc = (timeLeft / (12 * 60 * 60 * 1000)) * 100;
            fill.style.width = perc + "%";
            const h = Math.floor(timeLeft / 3600000), m = Math.floor((timeLeft % 3600000) / 60000), s = Math.floor((timeLeft % 60000) / 1000);
            text.innerText = `Kalan: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            fill.style.background = timeLeft < 3600000 ? (timeLeft < 900000 ? "#ef4444" : "#f59e0b") : "linear-gradient(90deg, #34d399, #2563eb)";
        }
    });
}, 1000);

function openModal(title, contentHTML, isBarcode = false, ean = "") {
    document.getElementById("modalTitle").innerText = title;
    const body = document.getElementById("modalBody");
    body.innerHTML = isBarcode ? '<svg id="barcodeCanvas"></svg>' : contentHTML;
    document.getElementById("mainModal").style.display = "flex";
    if(isBarcode && ean) {
        setTimeout(() => {
            try { JsBarcode("#barcodeCanvas", ean, { format: "CODE128", width: 2, height: 80, displayValue: true }); }
            catch (e) { body.innerHTML = "Barkod hatasƒ±: " + ean; }
        }, 100);
    }
}

const closeModal = () => document.getElementById("mainModal").style.display = "none";

async function findSectionInfo(orderProductId) {
    const modalBody = document.getElementById("modalBody");
    const targetId = orderProductId.trim();
    try {
        const response = await fetch('section.txt');
        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        const matches = lines.filter(line => line.split('\t')[0].trim() === targetId);
        if (matches.length > 0) {
            let tableHTML = `<table style="width:100%; border-collapse: collapse; font-size: 12px; margin-top: 10px;"><thead style="background: #f3f4f6;"><tr><th style="border: 1px solid #ddd; padding: 8px;">DEPO</th><th style="border: 1px solid #ddd; padding: 8px;">SECTION</th><th style="border: 1px solid #ddd; padding: 8px;">ADET</th></tr></thead><tbody>`;
            matches.forEach(match => {
                const cols = match.split('\t');
                tableHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${cols[3]||'-'}</td><td style="border: 1px solid #ddd; padding: 8px; font-weight:bold; color:#2563eb;">${cols[4]||'-'}</td><td style="border: 1px solid #ddd; padding: 8px;">${cols[5]||'-'}</td></tr>`;
            });
            modalBody.innerHTML = tableHTML + `</tbody></table>`;
        } else { modalBody.innerHTML = `<div style='color:red; padding:20px;'>Section yok!</div>`; }
    } catch (e) { modalBody.innerHTML = "Dosya hatasƒ±."; }
}

async function findMovementInfo(orderProductId) {
    const modalBody = document.getElementById("modalBody");
    const targetId = orderProductId.trim();
    try {
        const response = await fetch('hareket.txt');
        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        const matches = lines.filter(line => line.split('\t')[0] && line.split('\t')[0].trim() === targetId);
        if (matches.length > 0) {
            let sum = 0;
            let tableHTML = `<div style="overflow-x:auto;"><table style="width:100%; border-collapse: collapse; font-size: 10px; margin-top: 10px;"><thead style="background: #f3f4f6;"><tr><th style="border: 1px solid #ddd; padding: 6px;">DEPO</th><th style="border: 1px solid #ddd; padding: 6px;">KOD</th><th style="border: 1px solid #ddd; padding: 6px;">ADET</th><th style="border: 1px solid #ddd; padding: 6px;">TARƒ∞H</th><th style="border: 1px solid #ddd; padding: 6px;">A√áIKLAMA</th></tr></thead><tbody>`;
            matches.forEach(match => {
                const cols = match.split('\t');
                sum += parseFloat(cols[3]) || 0;
                tableHTML += `<tr><td style="border: 1px solid #ddd; padding: 6px;">${cols[1]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px;">${cols[2]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px; font-weight:bold;">${cols[3]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px;">${cols[4]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px;">${cols[5]||'-'}</td></tr>`;
            });
            modalBody.innerHTML = tableHTML + `<tr style="font-weight:bold;"><td colspan="2" style="text-align:right;">TOPLAM:</td><td>${sum}</td><td colspan="2"></td></tr></tbody></table></div>`;
        } else { modalBody.innerHTML = `<div style='color:red; padding:20px;'>Hareket yok!</div>`; }
    } catch (e) { modalBody.innerHTML = "Dosya hatasƒ±."; }
}

let lastClick = 0;
function handleDoubleClick(id) {
    const now = Date.now();
    if (now - lastClick < 400) window.open("https://www.boyner.com.tr/search?q=" + id.slice(0, -3), "_blank");
    lastClick = now;
}

async function shareProduct(product) {
    const user = localStorage.getItem("user");
    try {
        await fetch(`${baseDbUrl}/messages.json`, {
            method: "POST",
            body: JSON.stringify({ user, text: "Bir √ºr√ºn payla≈ütƒ±!", product, type: "product_share", timestamp: Date.now() })
        });
        alert("√úr√ºn ba≈üarƒ±yla payla≈üƒ±ldƒ±!");
    } catch (e) { alert("Payla≈üƒ±m ba≈üarƒ±sƒ±z."); }
}

document.addEventListener("contextmenu", e => e.preventDefault());
</script>

</body>
</html>