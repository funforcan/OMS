<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FunForCan - Mesajlar</title>
<style>
    * { box-sizing: border-box; }
    
    /* Body'yi flex yaparak ekranı böldük */
body { 
    margin: 0; 
    font-family: Arial, sans-serif; 
    background: #f4f6f9; 
    height: 100svh; /* Mobil uyumlu tam boy */
    display: flex;
    flex-direction: column; /* Üst üste diz: Header - Chat - Input */
    overflow: hidden;
	user-select: none; -webkit-user-select: none; overflow-x: hidden;
}
header { 
    height: 55px;
    background: #690000; 
    color: white; 
    padding: 0 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    font-weight: bold; 
    flex-shrink: 0; /* Ezilme diyoruz */
    z-index: 1002;
}
    header span { cursor: pointer; transition: 0.3s; }
    header .active { background: #000000; padding: 4px 10px; border-radius: 20px; font-size: 13px; }

    /* Chat alanı esnek olacak ama inputun üzerine binmeyecek */
/* Chat alanını esnet ve boşlukları ayarla */
#chat-container { 
    flex: 1; /* İşte sihir burada, kalan boşluğu milimetrik doldurur */
    overflow-y: auto; 
    padding: 15px; 
    display: flex; 
    flex-direction: column; 
    gap: 12px; 
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    /* Margin ve Absolute değerlerini tamamen sildik! */
}
    
    .message-card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-width: 80px; max-width: 85%; align-self: flex-start; }
    .my-message { align-self: flex-end; border-right: 4px solid #2563eb; }
    
    .msg-header { font-size: 11px; font-weight: bold; margin-bottom: 4px; display: flex; gap: 5px; }
    .user-title { font-style: italic; color: #6b7280; }
    .msg-text { font-size: 14px; word-wrap: break-word; }
    .msg-time { font-size: 9px; color: #9ca3af; text-align: right; margin-top: 5px; }

    /* İlerleme Çubuğu */
    .progress-bar-fill { height: 100%; transition: width 0.5s; width: 100%; }

#input-area { 
    height: 65px;
    background: white; 
    padding: 10px; 
    padding-bottom: env(safe-area-inset-bottom, 10px); /* iPhone alt boşluğu */
    display: flex; 
    gap: 10px; 
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
    flex-shrink: 0; /* Ezilme diyoruz */
    z-index: 1001;
}

/* Mobil uyumlu input */
input { 
    flex: 1; 
    padding: 0 15px; 
    height: 45px; 
    border-radius: 25px; 
    border: 1px solid #ddd; 
    outline: none; 
    font-size: 16px; 
}

#sendBtn { 
    background: #000000; 
    color: white; 
    border: none; 
    width: 80px;
    height: 45px;
    border-radius: 25px; 
    font-weight: bold; 
    cursor: pointer; 
}

    .empty-state { text-align: center; color: #9ca3af; margin-top: 50px; }
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<div id="mainModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;">
    <div style="background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center;">
        <h2 id="modalTitle" style="font-size: 16px;"></h2>
        <div id="modalBody"></div>
        <button onclick="closeModal()" style="margin-top: 15px; padding: 10px 20px; background: #111827; color: white; border: none; border-radius: 6px; width: 100%;">Kapat</button>
    </div>
</div>
<header>
    <div onclick="location.href='anasayfa.html'">Anasayfa</div>
    <div onclick="location.href='index.html'">Sepet</div>
    <div class="active">Mesajlar</div>
</header>

<div id="chat-container">
    <div class="empty-state">Mesajlar yükleniyor...</div>
</div>

<div id="input-area">
    <input type="text" id="msgInput" placeholder="Mesajınızı yazın..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button id="sendBtn" onclick="sendMessage()">Gönder</button>
</div>

<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<script>
const firebaseUrl = "https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app";
const currentUser = localStorage.getItem("user");
let lastMessageCount = 0;

if (!currentUser) location.href = "anasayfa.html";

function updateTimers() {
    document.querySelectorAll('.msg-timer-data').forEach(el => {
        const deadline = new Date(el.dataset.startdate).getTime() + (12 * 60 * 60 * 1000);
        const timeLeft = deadline - new Date().getTime();
        const fill = el.querySelector('.progress-bar-fill');
        const text = el.querySelector('.time-left-text');
        
        if (timeLeft <= 0) {
            if(fill) fill.style.width = "0%";
            if(text) text.innerText = "Süre Doldu!";
        } else {
            const perc = (timeLeft / (12 * 60 * 60 * 1000)) * 100;
            if(fill) {
                fill.style.width = perc + "%";
                fill.style.background = timeLeft < 3600000 ? (timeLeft < 900000 ? "#ef4444" : "#f59e0b") : "linear-gradient(90deg, #34d399, #2563eb)";
            }
            const h = Math.floor(timeLeft / 3600000), m = Math.floor((timeLeft % 3600000) / 60000), s = Math.floor((timeLeft % 60000) / 1000);
            if(text) text.innerText = `Kalan: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
    });
}

async function loadMessages() {
    try {
        const [msgRes, usersRes] = await Promise.all([
            fetch(`${firebaseUrl}/messages.json`),
            fetch(`${firebaseUrl}/UserList.json`)
        ]);
        
        const messages = await msgRes.json();
        const users = await usersRes.json();
        const chatContainer = document.getElementById("chat-container");
        
        if (!messages) return;

        const currentMsgCount = Object.keys(messages).length;
        if (currentMsgCount > lastMessageCount) {
            if (lastMessageCount !== 0) document.getElementById("msgSound").play().catch(() => {});
            lastMessageCount = currentMsgCount;
        } else {
            return; 
        }

        let chatHTML = "";
Object.keys(messages).forEach(id => {
    const m = messages[id];
    const uInfo = (users && users[m.user]) ? users[m.user] : {};
    
    // --- YENİ FİLTRELEME MANTIĞI BAŞLANGICI ---
    // Mevcut giriş yapan kullanıcının title bilgisini alalım
    const currentTitle = users[currentUser]?.userTitle || "";
    const senderTitle = uInfo.userTitle || "";

    // Eğer title'ların ilk 4 karakteri eşleşmiyorsa bu mesajı atla (gösterme)
    if (currentTitle.substring(0, 4) !== senderTitle.substring(0, 4)) {
        return; 
    }
    // --- YENİ FİLTRELEME MANTIĞI BİTİŞİ ---

    const isMe = m.user === currentUser;
    
    // Ürün paylaşımı ve HTML oluşturma kodları burada aynen devam ediyor...
    let productHTML = "";
    // ... (kodun geri kalanı aynı)
if (m.type === "product_share" && m.product) {
    const p = m.product;
    const safeDesc = p.description.replace(/'/g, "\\'");
    
    productHTML = `
    <div class="card" onclick="handleDoubleClick('${p.orderProductId}')" style="margin-top:10px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <img src="${p.imageUrl.replace(/\/mnresize\/\d+\/\d+\//, "/mnresize/500/700/")}" style="width:100%; height:100%; object-fit: cover;">
        <div style="padding:10px;">
            <div style="font-weight:bold; font-size:13px; color:#111827;">${p.brand}</div>
            <div style="font-size:11px; color:#374151; margin-bottom:5px; min-height: 32px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${p.description}</div>
            
            <div style="font-size:10px; color:#6b7280; background: #f9fafb; padding: 5px; border-radius: 4px; margin-bottom: 8px; line-height: 1.4;">
                <b>Beden:</b> ${p.size} | <b>Renk:</b> ${p.color || '-'}<br>
                <b>EAN:</b> ${p.ean || '-'}<br>
                <b>ID:</b> ${p.orderProductId || '-'}
            </div>

            <div class="msg-timer-data" data-startdate="${p.date}" style="margin: 8px 0;">
                <div style="width:100%; height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden;">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="time-left-text" style="font-size:10px; font-weight:bold; color:#4b5563; margin-top:3px;">...</div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 5px;">
                <div style="display: flex; gap: 4px;">
                    <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Stok Bilgisi Yükleniyor...')" style="flex:1; padding:8px 4px; font-size:10px; font-weight:bold; background:#690000; color:white; border:none; border-radius:4px;">STOK</button>
                    <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Yükleniyor...'); findMovementInfo('${p.orderProductId}')" style="flex:1; padding:8px 4px; font-size:10px; font-weight:bold; background:#690000; color:white; border:none; border-radius:4px;">HAREKET</button>
                </div>
                <div style="display: flex; gap: 4px;">
                    <button onclick="event.stopPropagation(); openModal('${safeDesc}', '', true, '${p.ean}')" style="flex:1; padding:8px 4px; font-size:10px; font-weight:bold; background:#690000; color:white; border:none; border-radius:4px;">BARKOD</button>
                    <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Yükleniyor...'); findSectionInfo('${p.orderProductId}')" style="flex:1; padding:8px 4px; font-size:10px; font-weight:bold; background:#690000; color:white; border:none; border-radius:4px;">SECTION</button>
                </div>
            </div>
        </div>
    </div>`;
}

            chatHTML += `
                <div class="message-card ${isMe ? 'my-message' : ''}" style="width: ${m.type === 'product_share' ? '60%' : 'auto'}; max-width: ${m.type === 'product_share' ? '280px' : '85%'};">
                    <div class="msg-header">
                        <span style="color: ${uInfo.userColor || '#2563eb'}">${m.user}</span>
                        <span class="user-title">[${uInfo.userTitle || 'Üye'}]</span>
                    </div>
                    <div class="msg-text" style="color: ${uInfo.userMessageColor || '#111827'}">${m.text}</div>
                    ${productHTML}
                    <div class="msg-time">${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>`;
        });
        
        chatContainer.innerHTML = chatHTML;
        setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 100);

    } catch (e) { console.log(e); }
}
// Mesajlar sayfasına eklenmesi gereken yardımcılar:

function openModal(title, contentHTML, isBarcode = false, ean = "") {
    document.getElementById("modalTitle").innerText = title;
    const body = document.getElementById("modalBody");
    body.innerHTML = isBarcode ? '<svg id="barcodeCanvas"></svg>' : contentHTML;
    document.getElementById("mainModal").style.display = "flex";
    if(isBarcode && ean) {
        setTimeout(() => {
            try { JsBarcode("#barcodeCanvas", ean, { format: "CODE128", width: 2, height: 80, displayValue: true }); }
            catch (e) { body.innerHTML = "Barkod hatası: " + ean; }
        }, 100);
    }
}

const closeModal = () => document.getElementById("mainModal").style.display = "none";

async function findSectionInfo(orderProductId) {
    const modalBody = document.getElementById("modalBody");
    try {
        const response = await fetch('section.txt');
        const text = await response.text();
        const matches = text.split(/\r?\n/).filter(line => line.split('\t')[0].trim() === orderProductId.trim());
        if (matches.length > 0) {
            let tableHTML = `<table style="width:100%; border-collapse: collapse; font-size: 11px;"><thead style="background: #f3f4f6;"><tr><th>DEPO</th><th>SEC</th><th>ADET</th></tr></thead><tbody>`;
            matches.forEach(match => {
                const cols = match.split('\t');
                tableHTML += `<tr><td>${cols[3]}</td><td style="color:#2563eb; font-weight:bold;">${cols[4]}</td><td>${cols[5]}</td></tr>`;
            });
            modalBody.innerHTML = tableHTML + `</tbody></table>`;
        } else { modalBody.innerHTML = "Section bulunamadı."; }
    } catch (e) { modalBody.innerHTML = "Dosya okuma hatası."; }
}

async function findMovementInfo(orderProductId) {
    const modalBody = document.getElementById("modalBody");
    const targetId = orderProductId.trim();
    try {
        const response = await fetch('hareket.txt');
        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        const matches = lines.filter(line => line.split('\t')[0] && line.split('\t')[0].trim() === targetId);
        if (matches.length > 0) {
            let sum = 0;
            let tableHTML = `<div style="overflow-x:auto;"><table style="width:100%; border-collapse: collapse; font-size: 10px; margin-top: 10px;"><thead style="background: #f3f4f6;"><tr><th style="border: 1px solid #ddd; padding: 6px;">DEPO</th><th style="border: 1px solid #ddd; padding: 6px;">KOD</th><th style="border: 1px solid #ddd; padding: 6px;">ADET</th><th style="border: 1px solid #ddd; padding: 6px;">TARİH</th><th style="border: 1px solid #ddd; padding: 6px;">AÇIKLAMA</th></tr></thead><tbody>`;
            matches.forEach(match => {
                const cols = match.split('\t');
                sum += parseFloat(cols[3]) || 0;
                tableHTML += `<tr><td style="border: 1px solid #ddd; padding: 6px;">${cols[1]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px;">${cols[2]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px; font-weight:bold;">${cols[3]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px;">${cols[4]||'-'}</td><td style="border: 1px solid #ddd; padding: 6px;">${cols[5]||'-'}</td></tr>`;
            });
            modalBody.innerHTML = tableHTML + `<tr style="font-weight:bold;"><td colspan="2" style="text-align:right;">TOPLAM:</td><td>${sum}</td><td colspan="2"></td></tr></tbody></table></div>`;
        } else { modalBody.innerHTML = `<div style='color:red; padding:20px;'>Hareket yok!</div>`; }
    } catch (e) { modalBody.innerHTML = "Dosya hatası."; }
}
let lastClick = 0;
function handleDoubleClick(id) {
    const now = Date.now();
    if (now - lastClick < 400) window.open("https://www.boyner.com.tr/search?q=" + id.slice(0, -3), "_blank");
    lastClick = now;
}
async function sendMessage() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;
    try {
        await fetch(`${firebaseUrl}/messages.json`, { method: "POST", body: JSON.stringify({ user: currentUser, text: text, timestamp: Date.now() }) });
        input.value = "";
        loadMessages();
    } catch (e) { console.log(e); }
}

setInterval(updateTimers, 1000);
setInterval(loadMessages, 3000);
loadMessages();
</script>

</body>
</html>