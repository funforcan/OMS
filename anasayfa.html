<!DOCTYPE html>
<html lang="tr">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FunForCan - E-Ticaret 3.0</title>
</head>
<body>
<div id="loader-overlay"><div class="loader"></div></div>
<div id="access-denied-overlay" style="position: fixed; inset: 0; background: #1d1d27; z-index: 999999; display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px;">
    <div style="background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 20px; border: 1px solid #ef4444; max-width: 400px;">
        <div style="font-size: 50px; margin-bottom: 20px;">⚠️</div>
        <h2 style="color: #ef4444; font-size: 18px; margin-bottom: 15px; font-weight: bold;">UYGULAMAYA ERİŞİMİNİZ YASAKLANMIŞTIR!</h2>
        <button onclick="logout()" style="background: #ef4444; color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer;">Çıkış Yap</button>
    </div>
</div>
<div id="top-area">
    <div id="content">
        <div class="tab-page active-page">
            <div id="auth-box" class="auth-container">
                <h2>E-Ticaret Asistan</h2>
                <div id="form-panel" class="expandable-panel">
                    <input type="text" id="username" placeholder="Sicil Numarası" />
                    <input type="password" id="password" placeholder="Şifre" />
                    <p style="margin-top:10px; text-align: center; font-size:12px; color:#6b7280;">Hesaba giriş yapmak için sicil ve şifrenizi kullanın.</p>
                    <button id="login-nav-btn" class="btn-main login-toggle" onclick="handleAuth()">Giriş Yap</button>
                </div>
                <div id="error"></div>
            </div>
            <div id="form-panel-2" class="auth-container hidden"> 
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                     <h3 style="color:#ffffff; text-align:left; margin:0; font-size: 14px;">
                        <span style="opacity: 0.7; font-size: 11px;">KULLANICI</span><br>
                        <span id="user-display" style="color:#00ABCC"></span>
                     </h3>
                    <button class="btn-main login-toggle" style="background:#00ABCC; border:none; margin:0; padding: 8px 15px; width: auto; color: #1d1d27; font-weight: bold;" onclick="logout()">Çıkış Yap</button>
                </div>
            </div>
            <div id="action-area" class="hidden"></div>
			<div id="admin-master-card" class="hidden"></div>
			<div id="admin-logs-card" class="hidden"></div>
			<div id="admin-bot-card" class="hidden"></div>
			<div id="admin-user-management-card" class="hidden"></div>
        </div>

        <div class="tab-page">
            <div class="card">
                <div class="bg"></div><div class="blob"></div>
                <div id="admin-users-list" style="position: relative; z-index: 3; width: 100%;"></div>
            </div>
            <div class="log-card" style="margin-top: 20px;">
                <div class="bg"></div>
                <div class="user-card-header" style="position: relative; z-index: 11; width: 100%;">
                    <div class="user-info" style="padding: 10px; text-align: left;"><span style="color: #00ABCC;">●</span> Sistem Hareketleri</div>
                </div>
                <div id="logs-list"><p style="text-align:center; padding:20px; color:#666;">Loglar yükleniyor...</p></div>
            </div>
        </div> 

        <div class="tab-page sepet-sayfasi"> 
            <div id="basket-header" class="basket-header-bar">
                <span class="header-item active-tab" id="tab-tekli" onclick="switchBasketMode('tekli')">TEKLİ</span>
                <span class="header-item" id="tab-coklu" onclick="switchBasketMode('coklu')">ÇOKLU</span>
                <span class="header-item right" id="basket-count-wrap" onclick="handleBasketRefresh()" style="cursor: pointer !important; pointer-events: auto !important; position: relative; z-index: 9999;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px; vertical-align: middle;">
                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/>
                    </svg>
                    ADET: <span id="basket-count">0</span>
                </span>
            </div>
            <div id="basket-content">
                <div id="container-tekli"></div>
                <div id="container-coklu" style="display: none;"></div>
            </div>
        </div>

        <div class="tab-page">
            <h2>BOYNER NOW</h2>
            <h3>Geliştirme aşamasındadır...</h3>		
        </div>

        <div class="tab-page" id="social-page" style="padding: 0; background: #f4f6f9; flex-direction: column; height: 100vh;">
            <div id="chat-container" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 80px;">
                <div class="empty-state" style="text-align: center; color: #9ca3af; margin-top: 50px;">Mesajlar yükleniyor...</div>
            </div>
            <div id="input-area" style="position: fixed; bottom: 50px; left: 0; right: 0; background: #1d1d27; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1001;">
                <input type="text" id="msgInput" placeholder="Mesajınızı yazın..." style="flex: 1; padding: 0 15px; height: 45px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 16px;" onkeypress="if(event.key==='Enter') sendMessage()">
                <button id="sendBtn" onclick="sendMessage()" style="background: #00ABCC; color: white; border: none; width: 80px; height: 45px; border-radius: 25px; font-weight: bold; cursor: pointer;">Gönder</button>
            </div>
            <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
        </div>

        <div id="mainModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 99999; padding: 20px;" onclick="if(event.target===this) closeModal()">
            <div style="background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; color: #333; position: relative;">
                <h2 id="modalTitle" style="font-size: 16px; margin-bottom:15px; border-bottom:1px solid #ddd; padding-bottom:10px;"></h2>
                <div id="modalBody"></div>
                <button onclick="closeModal()" style="margin-top: 20px; padding: 12px; background: #00ABCC; color: white; border: none; border-radius: 6px; width: 100%; font-weight: bold;">Kapat</button>
            </div>
        </div>
    </div>
</div>

<menu class="menu">
    <button class="menu__item active" data-target="home" style="--bgColorItem: #00ABCC;">
      <svg class="icon" viewBox="0 0 24 24"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
    </button>
    <button class="menu__item" data-target="bot" style="--bgColorItem: #00ABCC;">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 6V2H8"/><path d="M15 11v2"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M20 16a2 2 0 0 1-2 2H8.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 4 20.286V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z"/><path d="M9 11v2"/></svg>
    </button>
    <button class="menu__item" data-target="sepet" style="--bgColorItem: #00ABCC;">
      <svg class="icon" viewBox="0 0 24 24"><path d="m15 11-1 9"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8a2 2 0 0 0 2-1.6l1.7-7.4"/><path d="M4.5 15.5h15"/><path d="m5 11 4-7"/><path d="m9 11 1 9"/></svg>
    </button>
    <button class="menu__item" data-target="now" style="--bgColorItem: #00ABCC;"> 
      <svg class="icon" viewBox="0 0 24 24"><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg>
    </button>
    <button class="menu__item" data-target="social" style="--bgColorItem:#00ABCC;">
      <svg class="icon" viewBox="0 0 24 24"><path d="M16 10a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 14.286V4a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/><path d="M20 9a2 2 0 0 1 2 2v10.286a.71.71 0 0 1-1.212.502l-2.202-2.202A2 2 0 0 0 17.172 19H10a2 2 0 0 1-2-2v-1"/></svg>
    </button>
    <div class="menu__border"></div>
  </menu>
  <div class="svg-container">
    <svg viewBox="0 0 202.9 45.5"><clipPath id="menu" clipPathUnits="objectBoundingBox" transform="scale(0.0049285362247413 0.021978021978022)"><path d="M6.7,45.5c5.7,0.1,14.1-0.4,23.3-4c5.7-2.3,9.9-5,18.1-10.5c10.7-7.1,11.8-9.2,20.6-14.3c5-2.9,9.2-5.2,15.2-7c7.1-2.1,13.3-2.3,17.6-2.1c4.2-0.2,10.5,0.1,17.6,2.1c6.1,1.8,10.2,4.1,15.2,7c8.8,5,9.9,7.1,20.6,14.3c8.3,5.5,12.4,8.2,18.1,10.5c9.2,3.6,17.6,4.2,23.3,4H6.7z"/></clipPath></svg>
  </div>
<audio id="bing-sound" preload="auto"><source src="pop.wav" type="audio/wav"></audio>

<script src="js/js.js"></script>
<script>
let isAdmin = false;
let isModerator = false;
const baseDbUrl = "https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app";
let basketLoaded = false, basketLoaded2 = false;
let currentBasketTab = 'tekli';
let lastMessageCount = 0, socialInterval, lastProcessedLog = null, lastClick = 0;
let isAdminPanelCollapsed = false; // Panel durumunu hafızada tutar
let isAdminLogsCollapsed = true; 
let isLogUpdatePaused = false; // Log akışını durdurup başlatmak için
let isAdminBotCollapsed = true; // Bot yönetim paneli başlangıçta kapalı gelsin
let expandedUsers = []; // Açık olan kullanıcı id'lerini tutacak
let isUserMgmtCollapsed = true;
window.onload = async () => {
    const loader = document.getElementById("loader-overlay");
    try {
        const user = localStorage.getItem("user");
        
        if (user) {
            showLoggedInState(user);
            // İlk açılışta hemen kontrol et
            await checkUserStatus(); 
            
            renderUserPanel();
            renderLogs();
            
            // Periyodik kontrol döngüsü
            setInterval(async () => {
                const currentUser = localStorage.getItem("user");
                if (currentUser) { 
                    // Her 3 saniyede bir veritabanından statü kontrolü yap
                    await checkUserStatus(); 
                    
                    renderUserPanel(); 
                    renderLogs(); 
                    
                    if(typeof isAdmin !== 'undefined' && isAdmin) {
                        renderAdminPanel();
                        renderAdminLogsPanel();
                        renderBotManagementPanel();
                        renderUserManagementPanel();	
                    }
                    if(typeof isModerator !== 'undefined' && isModerator) {
                        renderBotManagementPanel();
                    }					
                }
            }, 3000);
        }
    } catch (err) { 
        console.error("Yükleme hatası:", err); 
    } finally {
        if (loader) {
            loader.style.opacity = "0";
            setTimeout(() => { 
                loader.style.display = "none"; 
                document.body.classList.add("page-ready"); 
            }, 400);
        }
    }
};

document.addEventListener("DOMContentLoaded", () => {
    const passwordInput = document.getElementById("password");
    if (passwordInput) passwordInput.addEventListener("keypress", e => { if (e.key === "Enter") handleAuth(); });
});

// --- KULLANICI YÖNETİM PANELİ ---
async function renderUserManagementPanel() {
    if (!isAdmin) return;
    const container = document.getElementById("admin-user-management-card");
    
    // Panel içindeki scroll konumunu korumak için
    const contentDiv = document.getElementById("user-mgmt-content");
    let currentScroll = contentDiv ? contentDiv.scrollTop : 0;

    try {
        // Tüm verileri paralel çekelim
        const [usersRes, basket1Res, basket2Res] = await Promise.all([
            fetch(`${baseDbUrl}/UserList.json`),
            fetch(`${baseDbUrl}/basketData.json`),
            fetch(`${baseDbUrl}/basketData2.json`)
        ]);

        const usersData = await usersRes.json();
        const basket1Data = await basket1Res.json() || {};
        const basket2Data = await basket2Res.json() || {};

        let rowsHtml = "";
        
        for (let userId in usersData) {
            const user = usersData[userId];
            
            // ID yerine userTitle'ı alıyoruz, eğer yoksa alternatif olarak ID'yi gösteriyoruz
            const displayName = user.userTitle ? user.userTitle : userId;

            // basketData içinde bu kullanıcıya ait obje sayısı
            const count1 = basket1Data[userId] ? Object.keys(basket1Data[userId]).length : 0;
            const count2 = basket2Data[userId] ? Object.keys(basket2Data[userId]).length : 0;
            
            rowsHtml += `
                <tr>
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${user.userStatu ? "checked" : ""} 
                                onchange="toggleUserStatus('${userId}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="user-id" style="font-size: 11px; color: #ffffff;">${displayName}</td>
                    <td style="color:#98F527; font-weight:bold;">${count1}</td>
                    <td style="color:#00ABCC; font-weight:bold;">${count2}</td>
                </tr>`;
        }

        const currentRotation = isUserMgmtCollapsed ? "rotate(-90deg)" : "rotate(0deg)";
        const displayStatus = isUserMgmtCollapsed ? "none" : "block";

        container.innerHTML = `
    <div style="width: 100%; background: #1d1d27; border-radius: 14px; border: 1px solid rgba(0, 171, 204, 0.3); overflow: hidden;">
        <div style="width:100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleUserMgmtPanel()">
            <div style="text-align: left; color: #ffffff; font-weight: 600;">
                <span style="color: #F527A9; margin-right: 5px;">●</span> Kullanıcı Yönetimi
            </div>
            <div id="user-mgmt-icon" style="transition: transform 0.3s ease; color: #F527A9; transform: ${currentRotation};">▼</div>
        </div>

        <div id="user-mgmt-content" style="display: ${displayStatus}; background: #16161f; border-top: 1px solid rgba(255,255,255,0.05);">
            
            <div style="max-height: 250px; overflow-y: auto; padding: 0 15px;">
                <table class="user-mgmt-table">
                    <thead style="position: sticky; top: 0; background: #16161f; z-index: 1;">
                        <tr>
                            <th>ERİŞİM</th>
                            <th style="text-align:left; padding-left:10px;">KULLANICI</th>
                            <th>TEKLİ</th>
                            <th>ÇOKLU</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            </div>

            <div style="padding: 15px;">
                <button class="refresh-all-btn" style="margin-top: 0;" onclick="refreshAllUsers()">TÜMÜNÜ YENİLE</button>
            </div>
        </div>
    </div>`;

        // Scroll konumunu geri yükle
        const newContentDiv = document.getElementById("user-mgmt-content");
        if (newContentDiv && !isUserMgmtCollapsed) {
            newContentDiv.scrollTop = currentScroll;
        }

    } catch (err) { console.error("Panel yükleme hatası:", err); }
}

// --- PANEL AKSİYONLARI ---

function toggleUserMgmtPanel() {
    isUserMgmtCollapsed = !isUserMgmtCollapsed;
    renderUserManagementPanel();
}

async function toggleUserStatus(userId, status) {
    try {
        await fetch(`${baseDbUrl}/UserList/${userId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ userStatu: status })
        });
    } catch (err) { console.error("Durum güncellenemedi:", err); }
}

async function refreshAllUsers() {
    if(!confirm("Tüm kullanıcıların verileri yenilenecek. Onaylıyor musunuz?")) return;
    try {
        const res = await fetch(`${baseDbUrl}/UserList.json`);
        const users = await res.json();
        const updates = {};
        
        for (let userId in users) {
            updates[`${userId}/refresh`] = true;
            updates[`${userId}/refresh2`] = true;
        }

        await fetch(`${baseDbUrl}/UserList.json`, {
            method: 'PATCH',
            body: JSON.stringify(updates)
        });
        alert("Tüm kullanıcılar için yenileme emri gönderildi.");
    } catch (err) { console.error("Yenileme hatası:", err); }
}
// --- ADMİN BOT YÖNETİM PANELİ (TÜM KULLANICILAR) ---
async function renderBotManagementPanel() {
    if (!isAdmin && !isModerator) return;
    const container = document.getElementById("admin-bot-card");
    const contentDiv = document.getElementById("admin-bot-content");
    
    // 1. MEVCUT SCROLL KONUMUNU KAYDET
    let currentScroll = 0;
    if (contentDiv) {
        currentScroll = contentDiv.scrollTop;
    }

    try {
        const [usersRes, serversRes] = await Promise.all([
            fetch(`${baseDbUrl}/UserList.json`),
            fetch(`${baseDbUrl}/ServerList.json`)
        ]);
        const usersData = await usersRes.json();
        const serversData = await serversRes.json();

        let usersHtml = "";
        
        for (let userId in usersData) {
            const userTitle = usersData[userId].userTitle || userId;
            let serverRows = "";
            
            // Bu kullanıcı detayları açık mı?
            const isUserExpanded = expandedUsers.includes(userId);
            
            for (let deviceId in serversData) {
    const device = serversData[deviceId];
    const tekKey = `${userId}_tek`;
    const cokKey = `${userId}_cok`;
    const isOnline = device.Status === true;
    
    // YENİ: Server değerine göre tıklanabilirlik kontrolü
    const isServerActive = device.Server === true; 

    serverRows += `
    <tr>
        <td style="text-align:left; padding-left:15px; color:#e0e0e0; font-size:11px;">
            <span style="color: ${isOnline ? '#10b981' : '#ef4444'}; margin-right: 5px;">●</span> ${deviceId}
        </td>
        <td>
            <label class="switch">
                <input type="checkbox" 
                    ${(device.UserList && device.UserList[tekKey] === true) ? "checked" : ""} 
                    ${!isServerActive ? "disabled" : ""} 
                    onchange="updateAdminUserBotStatus('${deviceId}', '${tekKey}', this.checked)">
                <span class="slider" style="${!isServerActive ? "opacity: 0.5; cursor: not-allowed;" : ""}"></span>
            </label>
        </td>
        <td>
            <label class="switch">
                <input type="checkbox" 
                    ${(device.UserList && device.UserList[cokKey] === true) ? "checked" : ""} 
                    ${!isServerActive ? "disabled" : ""} 
                    onchange="updateAdminUserBotStatus('${deviceId}', '${cokKey}', this.checked)">
                <span class="slider" style="${!isServerActive ? "opacity: 0.5; cursor: not-allowed;" : ""}"></span>
            </label>
        </td>
    </tr>`;
}

            usersHtml += `
                <div style="margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; background: rgba(0,0,0,0.2); overflow:hidden;">
                    <div style="padding: 10px; cursor: pointer; color: #00ABCC; font-weight: bold; font-size: 12px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.1);" 
                         onclick="toggleUserRow('${userId}')">
                        <span>${userTitle} (${userId})</span>
                        <span style="font-size: 10px; opacity: 0.7;">${isUserExpanded ? 'Kapat ▲' : 'Yönet ▼'}</span>
                    </div>
                    <div class="${isUserExpanded ? '' : 'hidden'}">
                        <table class="server-table" style="font-size: 10px; margin-bottom:0;">
                            <thead><tr><th style="text-align:left; padding-left:15px;">Sunucu</th><th>Tek</th><th>Çok</th></tr></thead>
                            <tbody>${serverRows}</tbody>
                        </table>
                    </div>
                </div>`;
        }

        const currentRotation = isAdminBotCollapsed ? "rotate(-90deg)" : "rotate(0deg)";
        const displayStatus = isAdminBotCollapsed ? "none" : "block";

        container.innerHTML = `
            <div style="width: 100%; background: #1d1d27; border-radius: 14px; border: 1px solid rgba(0, 171, 204, 0.3); overflow: hidden; margin-bottom: 10px;">
                <div style="width:100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1d1d27;" onclick="toggleBotPanel()">
                    <div style="text-align: left; color: #ffffff; font-weight: 600;">
                        <span style="color: #98F527; margin-right: 5px;">●</span> Bot Yönetimi
                    </div>
                    <div id="admin-bot-icon" style="transition: transform 0.3s ease; color: #98F527; font-size: 12px; transform: ${currentRotation};">▼</div>
                </div>
                <div id="admin-bot-content" style="display: ${displayStatus}; max-height: 300px; overflow-y: auto; padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); background: #16161f;">
                    ${usersHtml}
                </div>
            </div>`;

        // 2. SCROLL KONUMUNU GERİ YÜKLE
        const newContentDiv = document.getElementById("admin-bot-content");
        if (newContentDiv && !isAdminBotCollapsed) {
            newContentDiv.scrollTop = currentScroll;
        }

    } catch (err) { console.error("Bot yönetim paneli hatası:", err); }
}

// Kullanıcı satırını açıp kapatan yeni fonksiyon
function toggleUserRow(userId) {
    if (expandedUsers.includes(userId)) {
        expandedUsers = expandedUsers.filter(id => id !== userId);
    } else {
        expandedUsers.push(userId);
    }
    renderBotManagementPanel(); // Durum değişince hemen tekrar çiz
}

function toggleBotPanel() {
    isAdminBotCollapsed = !isAdminBotCollapsed;
    renderBotManagementPanel(); // Direkt render'ı çağırıyoruz ki state korunsun
}

// --- BOT DURUMU GÜNCELLEME (AYNI KALDI) ---
async function updateAdminUserBotStatus(deviceId, key, value) {
    try {
        // Firebase'e null gönderirsek siler, o yüzden direkt gelen boolean (true/false) değerini basıyoruz
        await fetch(`${baseDbUrl}/ServerList/${deviceId}/UserList/${key}.json`, {
            method: 'PUT',
            body: JSON.stringify(value) // Değer true ise true, false ise false gidecek
        });
        
        // Opsiyonel: Diğer panellerle senkronizasyon için render tetiklenebilir
        // renderBotManagementPanel(); 
    } catch (err) { 
        console.error("Bot güncelleme hatası:", err); 
    }
}
async function clearBasketData(type) {
    const userId = localStorage.getItem("user");
    if (!userId) return;
    const dbPath = type === 'tekli' ? 'basketData' : 'basketData2';
    const refreshKey = type === 'tekli' ? 'refresh' : 'refresh2';
    
    try {
        await fetch(`${baseDbUrl}/${dbPath}/${userId}.json`, { method: 'DELETE' });
        await fetch(`${baseDbUrl}/UserList/${userId}.json`, { method: 'PATCH', body: JSON.stringify({ [refreshKey]: true }) });
    } catch (err) { console.error(err); }
}

async function handleBasketRefresh() {
    const countSpan = document.getElementById("basket-count");
    const container = currentBasketTab === 'tekli' ? document.getElementById('container-tekli') : document.getElementById('container-coklu');
    const dbPath = currentBasketTab === 'tekli' ? 'basketData' : 'basketData2';

    countSpan.innerText = "...";
    countSpan.style.color = "#00ABCC";
    container.innerHTML = `<p style="text-align:center; color:#00ABCC; padding:20px;">Yeni veriler hazırlanıyor...</p>`;

    if (currentBasketTab === 'tekli') basketLoaded = false; else basketLoaded2 = false;

    await clearBasketData(currentBasketTab);
    pollForData(dbPath, container, val => { if(currentBasketTab === 'tekli') basketLoaded = val; else basketLoaded2 = val; });
}

function pollForData(dbPath, container, setLoadedFlag) {
    const userId = localStorage.getItem("user");
    let attempts = 0;
    const icon = document.querySelector("#basket-count-wrap svg");
    if (icon) icon.classList.add("fa-spin-custom");

    const interval = setInterval(async () => {
        attempts++;
        try {
            const res = await fetch(`${baseDbUrl}/${dbPath}/${userId}.json`);
            const data = await res.json();
            if (data && Object.keys(data).length > 0) {
                clearInterval(interval);
                if (icon) icon.classList.remove("fa-spin-custom");
                setLoadedFlag(false);
                dbPath === 'basketData' ? await loadBasketData() : await loadBasketData2();
            }
        } catch (e) { console.error(e); }

        if (attempts >= 20) {
            clearInterval(interval);
            if (icon) icon.classList.remove("fa-spin-custom");
            container.innerHTML = `<p style="text-align:center; color:#6b7280;">Zaman aşımı: Veri gelmedi.</p>`;
            document.getElementById("basket-count").innerText = "0";
        }
    }, 1000);
}

async function handleAuth() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const errorDiv = document.getElementById("error");
    const loginBtn = document.getElementById("login-nav-btn");

    errorDiv.innerText = "";
    if (!username || !password) { errorDiv.innerText = "Lütfen sicil numaranızı ve şifrenizi girin!"; return; }

    loginBtn.disabled = true; loginBtn.innerText = "Giriş yapılıyor...";

    try {
        const res = await fetch(`${baseDbUrl}/UserList/${username}.json`);
        const userData = await res.json();
        if (!userData) errorDiv.innerText = "Kullanıcı bulunamadı!";
        else if (userData.password !== password) errorDiv.innerText = "Girdiğiniz şifre hatalı!";
        else {
            localStorage.setItem("user", username);
            location.reload();
        }
    } catch (err) { errorDiv.innerText = "Bağlantı hatası!"; } 
    finally { loginBtn.disabled = false; loginBtn.innerText = "Giriş Yap"; }
}

async function showLoggedInState(username) {
    isAdmin = (username === "197127");
	isModerator = (username === "202185");
if (isAdmin) {
    document.getElementById("admin-master-card").classList.remove("hidden");
    document.getElementById("admin-logs-card").classList.remove("hidden"); // Bunu ekle
	document.getElementById("admin-bot-card").classList.remove("hidden"); // Yeni panel
	document.getElementById("admin-user-management-card").classList.remove("hidden");
    renderAdminPanel();
    renderAdminLogsPanel(); // Bunu ekle
	renderBotManagementPanel();
	renderUserManagementPanel();
}
if (isModerator) {
	document.getElementById("admin-bot-card").classList.remove("hidden"); // Yeni panel
	renderBotManagementPanel();
}
    try {
        const res = await fetch(`${baseDbUrl}/UserList/${username}.json`);
        const userData = await res.json();
        document.getElementById("user-display").innerText = (userData && userData.userTitle) ? userData.userTitle : username;
    } catch (err) { document.getElementById("user-display").innerText = username; }

    document.getElementById("auth-box")?.classList.add("hidden");
    document.getElementById("form-panel-2")?.classList.remove("hidden");
    document.getElementById("action-area")?.classList.remove("hidden");
}

function logout() { localStorage.removeItem("user"); location.reload(); }

async function renderUserPanel() {
    const user = localStorage.getItem("user");
    if (!user) return;
    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        const container = document.getElementById("admin-users-list");
        if (!container) return;

        let rows = "";
        for (let deviceId in serverData) {
            const device = serverData[deviceId];
            const tekKey = `${user}_tek`, cokKey = `${user}_cok`;
            const canUse = device.Active === true, isOnline = device.Status === true;
            
            rows += `
                <tr style="opacity: ${canUse ? '1' : '0.4'}">
                    <td style="text-align:left; padding-left:15px; color:#e0e0e0; font-weight:500;">
                        <span style="color: ${isOnline ? '#10b981' : '#ef4444'}; margin-right: 8px;">${isOnline ? '●' : '○'}</span> 
                        ${deviceId.replace("Device", "Sunucu ")}
                    </td>
                    <td><label class="switch">
                        <input type="checkbox" ${(device.UserList && device.UserList[tekKey] === true) ? "checked" : ""} 
                        ${!canUse ? "disabled" : ""} 
                        onchange="updateServerStatus('${deviceId}', '${tekKey}', this.checked)">
                        <span class="slider"></span>
                    </label></td>
                    <td><label class="switch">
                        <input type="checkbox" ${(device.UserList && device.UserList[cokKey] === true) ? "checked" : ""} 
                        ${!canUse ? "disabled" : ""} 
                        onchange="updateServerStatus('${deviceId}', '${cokKey}', this.checked)">
                        <span class="slider"></span>
                    </label></td>
                </tr>`;
        }

        container.innerHTML = `
            <div class="user-admin-card">
                <div class="user-card-header"><div class="user-info" style="padding: 10px;"><span style="color: #00ABCC;">●</span> Aktif Sunucu Listesi</div></div>
                <div class="user-card-content open">
                    <table class="server-table">
                        <thead><tr><th style="text-align:left; padding-left:15px;">Sunucu Durumu</th><th>Tekli</th><th>Çoklu</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
    } catch (err) { console.error(err); }
}

async function updateServerStatus(deviceId, key, value) {
    try {
        // null yerine direkt value (true veya false) gönderiyoruz
        await fetch(`${baseDbUrl}/ServerList/${deviceId}/UserList/${key}.json`, {
            method: 'PUT',
            body: JSON.stringify(value) 
        });
        // Kullanıcı panelini hemen tazeleyebiliriz
        renderUserPanel();
    } catch (err) {
        console.error("Durum güncelleme hatası:", err);
    }
}

async function renderLogs() {
    const user = localStorage.getItem("user"), container = document.getElementById("logs-list"), bingSound = document.getElementById("bing-sound");
    if (!user || !container) return;

    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`), serverData = await res.json();
        if (!serverData) return container.innerHTML = "Veri alınamadı.";

        let allLogs = [];
        for (let deviceId in serverData) {
            if (serverData[deviceId].logs) {
                Object.values(serverData[deviceId].logs).forEach(logMsg => {
                    const msgStr = String(logMsg);
                    if (msgStr.includes(user)) {
                        let cleaned = msgStr.replace(user + ":", "").replace("(Uzaktan)", "").trim();
                        if (!cleaned.endsWith(".")) cleaned += ".";
                        allLogs.push({ device: deviceId.replace("Device", "Server "), message: cleaned, time: cleaned.split(" : ")[0] || "00:00:00", raw: logMsg });
                    }
                });
            }
        }

        allLogs.sort((a, b) => b.time.localeCompare(a.time));
        allLogs = allLogs.slice(0, 50);

        if (allLogs.length > 0) {
            if (allLogs[0].message.includes("Eklendi") && lastProcessedLog !== allLogs[0].raw) {
                if(bingSound) bingSound.play().catch(()=>{});
                lastProcessedLog = allLogs[0].raw;
            }
            container.innerHTML = allLogs.map(log => {
                const parts = log.message.split(" : "), actionPart = parts[1] || log.message;
                const badgeColor = actionPart.includes("Etkisizleştirildi") ? "#B91010" : actionPart.includes("Etkinleştirildi") ? "#B9B610" : actionPart.includes("Eklendi") ? "#10b981" : "#ffffff";
                return `
                    <div style="margin: 8px; border-radius: 10px; background: rgba(0,171,204,0.85); border: 1px solid rgba(0,0,0,0.05); overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="padding: 6px 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.05);"><span style="font-size: 10px; font-weight: bold; color: #1d1d27;">${log.device}</span><span style="font-size: 10px; color: #1d1d27;">${parts[0] || ""}</span></div>
                        <div style="padding: 10px; background: ${badgeColor}; color: #1d1d27; font-size: 12px; font-weight: 600;">${actionPart}</div>
                    </div>`;
            }).join("");
        } else { container.innerHTML = "<div style='color:#777; text-align:center; padding:30px;'>Kayıt bulunamadı.</div>"; }
    } catch (err) { container.innerHTML = "Hata: " + err.message; }
}

async function switchBasketMode(mode) {
    if (currentBasketTab === mode) return; 
    const tekliCont = document.getElementById('container-tekli'), cokluCont = document.getElementById('container-coklu');
    
    document.getElementById('tab-tekli').classList.toggle('active-tab', mode === 'tekli');
    document.getElementById('tab-coklu').classList.toggle('active-tab', mode === 'coklu');
    tekliCont.style.display = mode === 'tekli' ? 'block' : 'none';
    cokluCont.style.display = mode === 'coklu' ? 'block' : 'none';
    
    if (mode === 'tekli') { !basketLoaded ? await loadBasketData() : updateBasketCountFromContainer(tekliCont); } 
    else { !basketLoaded2 ? await loadBasketData2() : updateBasketCountFromContainer(cokluCont); }
    currentBasketTab = mode;
}

async function loadBasketData() {
    if (basketLoaded) return;
    const userId = localStorage.getItem("user"), container = document.getElementById('container-tekli');
    container.innerHTML = `<p style="text-align:center; color:#666; padding:20px;">Yükleniyor...</p>`;

    try {
        const items = await (await fetch(`${baseDbUrl}/basketData/${userId}.json`)).json();
        if (items && items.length > 0) {
            container.innerHTML = `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px 8px 100px 8px;">${items.map(p => createProductCardHTML(p)).join('')}</div>`;
            basketLoaded = true; 
            document.getElementById("basket-count").innerText = items.length;
        } else { showEmptyInContainer(container); }
    } catch (e) { container.innerHTML = "Hata oluştu."; basketLoaded = false; }
}

async function loadBasketData2() {
    const userId = localStorage.getItem("user"), container = document.getElementById('container-coklu');
    container.innerHTML = `<p style="text-align:center; color:#666; padding:20px;">Yükleniyor...</p>`;

    try {
        const items = await (await fetch(`${baseDbUrl}/basketData2/${userId}.json`)).json();
        if (items && items.length > 0) {
            const grouped = items.reduce((acc, item) => {
                const binName = item.bin || "DİĞER";
                acc[binName] = acc[binName] || [];
                acc[binName].push(item);
                return acc;
            }, {});

            let html = `<div style="padding: 8px 8px 100px 8px;">`;
            for (const bin in grouped) {
                html += `
                <div class="bin-section">
                    <div class="bin-header" onclick="this.closest('.bin-section').classList.toggle('collapsed')" style="cursor:pointer; background: #333; color: #00ABCC; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span><span class="bin-icon">▼</span> <b>SEPET : ${bin}</b></span><span style="color: white; font-size: 11px;">${grouped[bin].length} Ürün</span>
                    </div>
                    <div class="bin-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 5px;">
                        ${grouped[bin].map(p => createProductCardHTML(p)).join('')}
                    </div>
                </div>`;
            }
            container.innerHTML = html + `</div>`;
            basketLoaded2 = true;
            document.getElementById("basket-count").innerText = items.length;
        } else { showEmptyInContainer(container); }
    } catch (e) { container.innerHTML = "Hata oluştu."; }
}

function updateBasketCountFromContainer(container) { document.getElementById("basket-count").innerText = container.querySelectorAll('.sepet-ozel-kart').length || 0; }
function showEmptyInContainer(container) {
    container.innerHTML = `<p style="margin-top:10px; text-align: center; font-size:12px; color:#6b7280;"> Sepetinizde ürün bulunmamaktadır.</p>`;
    document.getElementById("basket-count").innerText = "0";
}

function createProductCardHTML(p) {
    const safeDesc = p.description.replace(/'/g, "\\'");
    return `
    <div class="card sepet-ozel-kart" onclick="handleDoubleClick('${p.orderProductId}')" style="min-height: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <img src="${p.imageUrl.replace(/\/mnresize\/\d+\/\d+\//, "/mnresize/600/900/")}" style="width: 100%; height: 220px; object-fit: cover; pointer-events: none;" oncontextmenu="return false;" ondragstart="return false;">
        <div style="padding: 8px; display: flex; flex-direction: column; gap: 4px; flex-grow: 1;">
            <div style="font-weight: 700; font-size: 12px; color: #333; text-transform: uppercase;">${p.brand}</div>
            <div style="font-size: 11px; color: #444; height: 28px; overflow: hidden; line-height: 1.2;">${p.description}</div>
            <div class="urun-detay-kutusu">
                <div style="font-size: 10px; color: #555;"><b>BEDEN :</b> <span style="font-family: monospace;">${p.size}</span></div>
                <div style="font-size: 10px; color: #555;"><b>RENK :</b> <span style="font-family: monospace;">${p.color || '-'}</span></div>
                <div style="border-top: 1px solid #e0e0e0; padding-top: 4px; display: flex; flex-direction: column; gap: 1px;">
                    <div style="font-size: 10px; color: #555;"><b>EAN :</b> <span style="font-family: monospace;">${p.ean || 'YOK'}</span></div>
                    <div style="font-size: 10px; color: #555;"><b>MALZEME :</b> <span style="font-family: monospace;">${p.orderProductId}</span></div>
                </div>
            </div>
            <div class="timer-data" data-startdate="${p.date}" style="width: 100%;">
                <div style="width: 100%; height: 6px; background: #e0e0e0; border-radius: 10px; overflow: hidden;"><div class="progress-bar-fill" style="height: 100%; width: 100%; background: #34d399;"></div></div>
                <div style="font-size: 10px; font-weight: 600; color: #666; text-align: center; margin-top: 0px;" class="time-left-text">00:00:00</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: auto; position: relative; z-index: 999;">
                <button onclick="event.stopPropagation(); openModal('${safeDesc}', 'Stok bilgisi sorgulanıyor...')" style="font-size: 10px; padding: 10px 0; background: #00ABCC; color: white; border: none; border-radius: 5px; font-weight: bold;">STOK</button>
                <button onclick="event.stopPropagation(); findMovementInfo('${p.orderProductId}', '${safeDesc}')" style="font-size: 10px; padding: 10px 0; background: #00ABCC; color: white; border: none; border-radius: 5px; font-weight: bold;">HAREKET</button>
                <button onclick="event.stopPropagation(); openModal('${safeDesc}', '', true, '${p.ean}')" style="font-size: 10px; padding: 10px 0; background: #333; color: white; border: none; border-radius: 5px; font-weight: bold;">BARKOD</button>
                <button onclick="event.stopPropagation(); findSectionInfo('${p.orderProductId}', '${safeDesc}')" style="font-size: 10px; padding: 10px 0; background: #333; color: white; border: none; border-radius: 5px; font-weight: bold;">SECTION</button>
            </div>
        </div>
    </div>`;
}

function handleDoubleClick(id) {
    const now = Date.now();
    if (now - lastClick < 400) window.open("https://www.boyner.com.tr/search?q=" + id.slice(0, -3), "_blank");
    lastClick = now;
}

function openModal(title, contentHTML, isBarcode = false, ean = "") {
    document.getElementById("modalTitle").innerText = title;
    const body = document.getElementById("modalBody");
    body.innerHTML = isBarcode ? '<svg id="barcodeCanvas"></svg>' : contentHTML;
    document.getElementById("mainModal").style.display = "flex";
    if(isBarcode && ean) {
        setTimeout(() => {
            try { JsBarcode("#barcodeCanvas", ean, { format: "CODE128", width: 2, height: 60, displayValue: true }); }
            catch (e) { body.innerHTML = "Barkod hatası: " + ean; }
        }, 100);
    }
}

const closeModal = () => document.getElementById("mainModal").style.display = "none";

async function findMovementInfo(orderProductId, title) {
    document.getElementById("modalTitle").innerText = title;
    const modalBody = document.getElementById("modalBody");
    modalBody.innerHTML = "Yükleniyor...";
    document.getElementById("mainModal").style.display = "flex";

    try {
        // Kullanıcı bilgisinden CM76 gibi prefix'i alıyoruz
        const userDisplay = document.getElementById("user-display").innerText.trim();
        const prefix = userDisplay.substring(0, 4);
        const fileName = `hareket-${prefix}.txt`;

        const response = await fetch(fileName);
        
        if (!response.ok) {
            modalBody.innerHTML = `<div style='color:#ef4444; padding:20px;'>(${prefix}) için hareket dosyası bulunamadı.</div>`;
            return;
        }

        const content = await response.text();
        // Satırları böl ve boş satırları temizle
        const lines = content.split(/\r?\n/).filter(l => l.trim() !== "");
        
        // Eşleşme kontrolü: Hem ürün ID'sini hem de satırdaki veriyi trim (temizle) yapıyoruz
        const searchId = String(orderProductId).trim();
        const matches = lines.filter(l => {
            const firstCol = l.split('\t')[0];
            return firstCol && firstCol.trim() === searchId;
        });

        if (matches.length > 0) {
            let sum = 0;
            let html = `<div style="overflow-x:auto;"><table style="width:100%; border-collapse: collapse; font-size: 10px;"><tr style="background: #f3f4f6;"><th>KOD</th><th>ADET</th><th>TARİH</th><th>AÇIKLAMA</th></tr>`;
            
            matches.forEach(m => {
                const c = m.split('\t');
                const adet = parseFloat(c[3]) || 0;
                sum += adet;
                html += `<tr><td>${c[2]||'-'}</td><td style="font-weight:bold;">${adet}</td><td>${c[4]||'-'}</td><td>${c[5]||'-'}</td></tr>`;
            });
            
            modalBody.innerHTML = html + `<tr style="font-weight:bold;"><td style="text-align:right;">TOPLAM:</td><td>${sum}</td><td colspan="2"></td></tr></table></div>`;
        } else {
            modalBody.innerHTML = `<div style='color:#ef4444; padding:20px;'>${fileName} içerisinde "${searchId}" koduna ait hareket bulunamadı.</div>`;
        }
    } catch (e) { 
        modalBody.innerHTML = "Sistem hatası: " + e.message; 
    }
}

window.findSectionInfo = async function(orderProductId, title) {
    document.getElementById("modalTitle").innerText = title;
    const modalBody = document.getElementById("modalBody");
    modalBody.innerHTML = "Yükleniyor...";
    document.getElementById("mainModal").style.display = "flex";

    try {
        const userDisplay = document.getElementById("user-display").innerText.trim();
        const prefix = userDisplay.substring(0, 4);
        const fileName = `section-${prefix}.txt`;

        const response = await fetch(fileName);

        if (!response.ok) {
            modalBody.innerHTML = `<div style='color:#ef4444; padding:20px;'>(${prefix}) için section dosyası bulunamadı.</div>`;
            return;
        }

        const content = await response.text();
        const lines = content.split(/\r?\n/).filter(l => l.trim() !== "");
        const searchId = String(orderProductId).trim();

        const matches = lines.filter(l => {
            const cols = l.split('\t');
            return cols[0] && cols[0].trim() === searchId;
        });

        if (matches.length > 0) {
            let html = `<table style="width:100%; font-size: 11px; border-collapse: collapse;"><tr style="background:#eee;"><th>DEPO</th><th>SEC</th><th>ADET</th></tr>`;
            matches.forEach(m => { 
                const c = m.split('\t'); 
                html += `<tr><td>${c[3]||'-'}</td><td style="font-weight:bold; color:blue;">${c[4]||'-'}</td><td>${c[5]||'-'}</td></tr>`; 
            });
            modalBody.innerHTML = html + `</table>`;
        } else {
            modalBody.innerHTML = `<div style='color:#ef4444; padding:20px;'>${fileName} içerisinde "${searchId}" koduna ait yer bilgisi bulunamadı.</div>`;
        }
    } catch (e) { 
        modalBody.innerHTML = "Sistem hatası."; 
    }
}

function startSocialMode() { loadMessages(); socialInterval = setInterval(loadMessages, 3000); }

async function loadMessages() {
    try {
        const [msgRes, usersRes] = await Promise.all([fetch(`${baseDbUrl}/messages.json`), fetch(`${baseDbUrl}/UserList.json`)]);
        const messages = await msgRes.json(), users = await usersRes.json(), chatContainer = document.getElementById("chat-container");
        
        if (!messages) return chatContainer.innerHTML = '<div class="empty-state">Henüz mesaj yok.</div>';

        const currentMsgCount = Object.keys(messages).length;
        if (currentMsgCount > lastMessageCount) {
            if (lastMessageCount !== 0) document.getElementById("msgSound")?.play().catch(()=>{});
            lastMessageCount = currentMsgCount;
        } else return; 

        let chatHTML = "";
        const currentUser = localStorage.getItem("user"), currentTitle = users[currentUser]?.userTitle || "";

        Object.keys(messages).forEach(id => {
            const m = messages[id], uInfo = users[m.user] || {}, senderTitle = uInfo.userTitle || "";
            if (currentTitle.substring(0, 4) !== senderTitle.substring(0, 4)) return;

            const isMe = m.user === currentUser;
            let productHTML = "";
            if (m.type === "product_share" && m.product) {
                productHTML = `<div class="shared-product-wrapper" style="margin-top: 10px; width: 100%; color: #333 !important;">${createProductCardHTML(m.product).replace('onclick="removeItem', 'style="display:none" onclick="removeItem')}</div>`;
            }

            chatHTML += `
                <div class="message-card ${isMe ? 'my-message' : ''}" style="width: ${m.type === 'product_share' ? '280px' : 'auto'}; max-width: 85%;">
                    <div class="msg-header"><span style="color: ${isMe ? '#fff' : (uInfo.userColor || '#00ABCC')}">${m.user}</span><span class="user-title" style="opacity: 0.8; font-size: 10px; margin-left: 5px;">[${uInfo.userTitle || 'Üye'}]</span></div>
                    <div class="msg-text" style="word-break: break-word;">${m.text}</div>${productHTML}
                    <div class="msg-time" style="font-size: 9px; margin-top: 5px; text-align: right; opacity: 0.7;">${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>`;
        });
        
        chatContainer.innerHTML = chatHTML;
        setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 100);
    } catch (e) { console.error(e); }
}

async function sendMessage() {
    const input = document.getElementById("msgInput"), text = input.value.trim(), currentUser = localStorage.getItem("user");
    if (!text) return;
    try {
        await fetch(`${baseDbUrl}/messages.json`, { method: "POST", body: JSON.stringify({ user: currentUser, text: text, timestamp: Date.now() }) });
        input.value = ""; loadMessages();
    } catch (e) { console.error(e); }
}

setInterval(() => {
    document.querySelectorAll('.timer-data').forEach(el => {
        const timeLeft = (new Date(el.dataset.startdate).getTime() + 12 * 60 * 60 * 1000) - new Date().getTime();
        const fill = el.querySelector('.progress-bar-fill'), text = el.querySelector('.time-left-text');
        if (!fill || !text) return;

        if (timeLeft <= 0) {
            fill.style.width = "0%"; fill.style.background = "#ef4444"; text.innerText = "Süre Doldu!"; text.style.color = "#ef4444";
        } else {
            fill.style.width = ((timeLeft / (12 * 60 * 60 * 1000)) * 100) + "%";
            const h = Math.floor(timeLeft / 3600000), m = Math.floor((timeLeft % 3600000) / 60000), s = Math.floor((timeLeft % 60000) / 1000);
            text.innerText = `Kalan: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            fill.style.background = timeLeft < 900000 ? "#ef4444" : timeLeft < 3600000 ? "#f59e0b" : "#34d399";
        }
    });
}, 1000);
// --- ADMİN SUNUCU YÖNETİM PANELİ FONKSİYONLARI ---

async function renderAdminPanel() {
    // Sadece admin ise çalışsın
    if (!isAdmin) return;
    const container = document.getElementById("admin-master-card");
    if (!container) return;

    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        
        let rows = "";
        for (let deviceId in serverData) {
            const device = serverData[deviceId];
            
            // Veritabanından gelen boolean değerler
            const isOnline = device.Status === true;
            const isActive = device.Active === true;
            const isServer = device.Server === true;
            
            rows += `
                <tr>
                    <td style="text-align:left; padding-left:15px; color:#e0e0e0; font-weight:500;">
                        <span style="color: ${isOnline ? '#10b981' : '#ef4444'}; margin-right: 8px;">●</span> 
                        ${deviceId}
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${isActive ? "checked" : ""} onchange="updateAdminServerStatus('${deviceId}', 'Active', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${isServer ? "checked" : ""} onchange="updateAdminServerStatus('${deviceId}', 'Server', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                </tr>`;
        }

        // Durum değişkenine göre dinamik değerler
const currentRotation = isAdminPanelCollapsed ? "rotate(-90deg)" : "rotate(0deg)";
const currentMaxHeight = isAdminPanelCollapsed ? "0px" : "2000px";
const displayStyle = isAdminPanelCollapsed ? "none" : "block"; // Tamamen yok saymak için

container.innerHTML = `
    <div style="width: 100%; background: #1d1d27; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; margin-bottom: 10px;">
        
        <div style="width:100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1d1d27;" onclick="toggleAdminPanel()">
            <div style="text-align: left; color: #ffffff; font-weight: 600;">
                <span style="color: #00ABCC; margin-right: 5px;">●</span> Sunucu Yönetimi
            </div>
            <div id="admin-panel-icon" style="transition: transform 0.3s ease; color: #00ABCC; font-size: 12px; transform: ${currentRotation};">▼</div>
        </div>
        
        <div id="admin-panel-content" style="max-height: ${currentMaxHeight}; overflow: hidden; transition: max-height 0.3s ease-in-out;">
            <div style="padding: 0 15px 15px 15px; border-top: 1px solid rgba(255,255,255,0.05);">
                <table class="server-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="color: #6b7280; font-size: 12px; text-transform: uppercase;">
                            <th style="text-align:left; padding: 10px 0;">Sunucu</th>
                            <th style="text-align:center;">ERİŞİM</th>
                            <th style="text-align:center;">SERVER</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                
                <div style="display:flex; flex-direction:column; gap:8px; margin-top:15px;">
                    <button class="btn-main" style="background:#00ABCC; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer;" onclick="event.stopPropagation(); adminAction('check')">CHECK</button>
                    <button class="btn-main" style="background:#00ABCC; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer;" onclick="event.stopPropagation(); adminAction('clear_log')">CLEAR LOG</button>
                    <button class="btn-main" style="background:#00ABCC; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer;" onclick="event.stopPropagation(); adminAction('clear_chat')">CLEAR CHAT</button>
                </div>
            </div>
        </div>
    </div>`;
    } catch (err) { console.error("Hata:", err); }
}
function toggleAdminPanel() {
    isAdminPanelCollapsed = !isAdminPanelCollapsed;
    const content = document.getElementById("admin-panel-content");
    const icon = document.getElementById("admin-panel-icon");
    
    if (isAdminPanelCollapsed) {
        content.style.maxHeight = "0px";
        icon.style.transform = "rotate(-90deg)";
    } else {
        // scrollHeight sayesinde içeriğin gerçek yüksekliğini alır
        content.style.maxHeight = content.scrollHeight + "px";
        icon.style.transform = "rotate(0deg)";
        
        // Animasyon bittikten sonra limiti kaldır ki yeni satır eklenirse büyüyebilsin
        setTimeout(() => {
            if(!isAdminPanelCollapsed) content.style.maxHeight = "2000px";
        }, 300);
    }
}
// Switchlerden gelen komutla veritabanını anında günceller
async function updateAdminServerStatus(deviceId, key, value) {
    try {
        await fetch(`${baseDbUrl}/ServerList/${deviceId}.json`, {
            method: 'PATCH', 
            body: JSON.stringify({ [key]: value })
        });
        // İşlem bitince arayüzü yenile
        renderAdminPanel(); 
    } catch (err) { console.error("Admin güncelleme hatası:", err); }
}

// Admin buton görevleri
async function adminAction(action) {
    try {
        if (action === 'check') {
            // Önce mevcut ServerList'i çekip hepsi için Status = false objesi hazırlıyoruz
            const serverData = await (await fetch(`${baseDbUrl}/ServerList.json`)).json();
            const updates = {};
            for (let deviceId in serverData) {
                updates[`${deviceId}/Status`] = false;
            }
            await fetch(`${baseDbUrl}/ServerList.json`, { method: 'PATCH', body: JSON.stringify(updates) });
            alert("Tüm sunucuların Status değeri 'false' yapıldı.");
            
        } else if (action === 'clear_log') {
            // Bütün cihazları gezip içlerindeki "logs" düğümünü siliyoruz
            const serverData = await (await fetch(`${baseDbUrl}/ServerList.json`)).json();
            for (let deviceId in serverData) {
                await fetch(`${baseDbUrl}/ServerList/${deviceId}/logs.json`, { method: 'DELETE' });
            }
            alert("Tüm sunucu logları temizlendi.");
            renderLogs(); // Mevcut log panelini de temizlemek için
            
        } else if (action === 'clear_chat') {
            // Doğrudan messages düğümünü siliyoruz
            await fetch(`${baseDbUrl}/messages.json`, { method: 'DELETE' });
            alert("Sohbet (Chat) başarıyla temizlendi.");
            loadMessages(); // Ekranda görünen chatleri uçurmak için
        }
        
        renderAdminPanel(); // Buton işlemlerinden sonra tabloyu güncelle
    } catch (err) { 
        console.error("Admin işlem hatası:", err); 
        alert("Bir hata oluştu!"); 
    }
}
async function renderAdminLogsPanel() {
    if (!isAdmin) return;
    if (isLogUpdatePaused) return;

    const container = document.getElementById("admin-logs-card");
    if (!container) return;

    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        
        let allLogsArray = [];

        // 1. Tüm cihazlardaki logları tek bir havuzda topla
        for (let deviceId in serverData) {
            const logs = serverData[deviceId].logs;
            if (logs) {
                for (let logId in logs) {
                    const logContent = (typeof logs[logId] === 'object') ? logs[logId].message : logs[logId];
                    
                    // Saati ayıklayalım (Format: "15:10:30 : ...")
                    const timeMatch = logContent.match(/^(\d{2}:\d{2}:\d{2})/);
                    const timeValue = timeMatch ? timeMatch[1] : "00:00:00";

                    allLogsArray.push({
                        deviceId: deviceId,
                        fullText: logContent,
                        time: timeValue // Sıralama için kullanacağız
                    });
                }
            }
        }

        // 2. SADECE SAATE GÖRE SIRALA (En yeni saat en üstte)
        allLogsArray.sort((a, b) => b.time.localeCompare(a.time));

        let logRows = "";
        allLogsArray.forEach(item => {
            const parts = item.fullText.split(':');
            let formattedLine = "";
            
            if (parts.length >= 4) {
                const timePart = `${parts[0].trim()}:${parts[1].trim()}:${parts[2].trim()}`;
                const sicilPart = parts[3].trim();
                const msgPart = parts.slice(4).join(':').trim();
                formattedLine = `<span style="color: #6b7280;">${timePart} - </span><span style="color: #ffffff;">${sicilPart}</span> : <span style="color: #e0e0e0;">${msgPart}</span>`;
            } else {
                formattedLine = item.fullText;
            }

            logRows += `
                <div style="padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 11px; line-height: 1.4;">
                    <span style="color: #00ABCC; font-weight: bold; margin-right: 5px;">[${item.deviceId}]</span> 
                    ${formattedLine}
                </div>`;
        });

        if (allLogsArray.length === 0) {
            logRows = '<div style="padding:15px; color:#6b7280; font-size:12px; text-align:center;">Henüz log kaydı yok.</div>';
        }

        const currentRotation = isAdminLogsCollapsed ? "rotate(-90deg)" : "rotate(0deg)";
        const currentMaxHeight = isAdminLogsCollapsed ? "0px" : "400px";
        const pauseBtnText = isLogUpdatePaused ? "AKışı BAŞLAT" : "AKışı DURDUR";
        const pauseBtnColor = isLogUpdatePaused ? "#10b981" : "#ef4444";

        container.innerHTML = `
            <div style="width: 100%; background: #1d1d27; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; margin-bottom: 10px;">
                <div style="width:100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1d1d27;" onclick="toggleAdminLogsPanel()">
                    <div style="text-align: left; color: #ffffff; font-weight: 600;">
                        <span style="color: #f59e0b; margin-right: 5px;">●</span> Sistem Logları
                    </div>
                    <div id="admin-logs-icon" style="transition: transform 0.3s ease; color: #f59e0b; font-size: 12px; transform: ${currentRotation};">▼</div>
                </div>
                <div id="admin-logs-content" style="max-height: ${currentMaxHeight}; overflow-y: auto; transition: max-height 0.3s ease-in-out; background: #1a1a23;">
                    <div style="padding: 10px 15px; background: #14141b; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: flex-end;">
                        <button onclick="event.stopPropagation(); toggleLogPause()" style="background: transparent; border: 1px solid ${pauseBtnColor}; color: ${pauseBtnColor}; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold; text-transform: uppercase;">
                            ${pauseBtnText}
                        </button>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.05);">
                        ${logRows}
                    </div>
                </div>
            </div>`;
    } catch (err) { console.error("Log hatası:", err); }
}
function toggleAdminLogsPanel() {
    isAdminLogsCollapsed = !isAdminLogsCollapsed;
    const content = document.getElementById("admin-logs-content");
    const icon = document.getElementById("admin-logs-icon");
    
    if (isAdminLogsCollapsed) {
        content.style.maxHeight = "0px";
        icon.style.transform = "rotate(-90deg)";
    } else {
        content.style.maxHeight = "400px"; // İçerik çok uzun olabileceği için sabit max-height ve scroll daha iyi olur
        icon.style.transform = "rotate(0deg)";
    }
}
function toggleLogPause() {
    isLogUpdatePaused = !isLogUpdatePaused;
    // Buton metnini ve rengini anında değiştirmek için paneli bir kez manuel tetikleyelim
    // Ancak pause durumuna geçtiysek render fonksiyonu en başta return olacağı için 
    // sadece görselliği elle de değiştirebiliriz. En temizi renderAdminLogsPanel'i pause kontrolünü 
    // aşacak küçük bir parametreyle çağırmaktır:
    renderAdminLogsPanelInternal(); 
}

// Yardımcı bir fonksiyon: Pause durumuna bakmadan render eder (Sadece buton değişimi için)
async function renderAdminLogsPanelInternal() {
    // Geçici olarak pause'u görmezden gelip başlığı/butonu güncellemek için...
    // Yukarıdaki renderAdminLogsPanel fonksiyonunun başına eklediğimiz `if(isLogUpdatePaused) return;` 
    // kontrolünü sadece buton değişim anında aşmak için tasarlandı.
    const tempPaused = isLogUpdatePaused;
    isLogUpdatePaused = false; 
    await renderAdminLogsPanel();
    isLogUpdatePaused = tempPaused;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</body>
</html>
