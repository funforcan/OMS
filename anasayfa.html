<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FunForCan - E-Ticaret 3.0</title>
<style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f6f9; user-select: none; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; user-select: none; -webkit-user-select: none; overflow-x: hidden;}
    
    header { position: fixed; top: 0; left: 0; width: 100%; background: #690000; color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; font-weight: bold; }
    
    /* MenÃ¼ butonlarÄ± varsayÄ±lan olarak pasif (tÄ±klanamaz) */
    header span { 
        opacity: 0.4; 
        cursor: not-allowed; 
        transition: 0.3s;
    }
    
    /* GiriÅŸ yapÄ±lÄ±nca eklenecek aktif sÄ±nÄ±fÄ± */
    header span.enabled { 
        opacity: 1; 
        cursor: pointer; 
    }
#action-area {
    transition: all 0.3s ease;
}
    header .active, #count { background: #000000; padding: 4px 10px; border-radius: 20px; font-size: 13px; opacity: 1; }
    
#content { 
    padding: 80px 20px 20px; 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
}

    /* GiriÅŸ Paneli */
    .auth-container { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 3px 12px rgba(0,0,0,0.15); width: 320px; text-align: center; }
    .auth-container h2 { margin-bottom: 20px; color: #111827; font-size: 20px; }
    
    .expandable-panel { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
    .expandable-panel.open { max-height: 300px; margin-top: 15px; }

    input { width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    
    .btn-main { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
    .login-toggle { background: #000000; }
    .register-toggle { background: #10b981; }
    .action-btn { background: #111827; margin-top: 10px; }

    #error { color: #dc2626; font-size: 13px; margin-top: 10px; min-height: 18px; }

    /* Ã‡Ä±kÄ±ÅŸ Yap Butonu */
    #logout-area { width: 100%; padding: 20px; display: none; justify-content: center; }
    .logout-btn { background: #640000; color: white; border: none; padding: 12px 40px; border-radius: 6px; font-weight: bold; cursor: pointer; }

    .hidden { display: none !important; }
/* Switch (Toggle) Buton TasarÄ±mÄ± */
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #10b981; }
input:checked + .slider:before { transform: translateX(20px); }

/* Ana Sistem YÃ¶netimi Paneli */
.admin-main-card {
    width: 100%; /* %96'dan %98'e Ã§Ä±karÄ±ldÄ±, kenar boÅŸluklarÄ± azaltÄ±ldÄ± */
    max-width: 1500px; /* Maksimum geniÅŸlik artÄ±rÄ±ldÄ± (veya tamamen kaldÄ±rabilirsin) */
    background: #640000; 
    color: white;
    border-radius: 12px;
    margin: 10px auto; /* Ãœst-alt boÅŸluk biraz azaltÄ±ldÄ± */
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
#admin-main-container {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 10px; /* Kenarlara yapÄ±ÅŸmamasÄ± iÃ§in Ã§ok hafif iÃ§ boÅŸluk */
    box-sizing: border-box;
}
.server-table th, .server-table td {
    padding: 12px 15px; /* HÃ¼cre iÃ§ boÅŸluklarÄ± artÄ±rÄ±larak daha dolgun gÃ¶rÃ¼nmesi saÄŸlandÄ± */
}
.admin-main-header {
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
}
#admin-users-list, #admin-server-list {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.admin-main-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out;
    background: #940000; /* Ä°Ã§erik aÃ§Ä±ldÄ±ÄŸÄ±nda yine aÃ§Ä±k renk olsun */
    padding: 0 10px;
}

.admin-main-content.open {
    max-height: 2000px; /* Ä°Ã§erik Ã§oksa geniÅŸ tutuyoruz */
    padding: 15px 10px;
}

/* Ana Kart YapÄ±sÄ± */
/* User kartlarÄ±nÄ±n da tam geniÅŸlikte olmasÄ± iÃ§in */
.user-admin-card { 
    background: white; 
    border-radius: 8px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    margin-bottom: 8px; 
    width: 100%; /* Ä°Ã§erideki kartlar da tam geniÅŸlik */
    max-width: 100%; 
    border: 1px solid #e5e7eb;
}

/* BaÅŸlÄ±k AlanÄ± (HizalanmÄ±ÅŸ) */
.user-card-header { 
    padding: 12px 16px; 
    cursor: pointer; 
    display: flex; 
    align-items: center;
    background: #f9fafb;
    transition: background 0.2s;
}
.user-card-header:hover { background: #f3f4f6; }

/* Ok Ä°konu En Sola */
.chevron { 
    margin-right: 12px; 
    font-size: 12px; 
    transition: transform 0.3s;
    color: #6b7280;
}
.open-icon { transform: rotate(90deg); }

.user-info { font-weight: 600; color: #111827; flex: 1; }
.user-id-tag { font-size: 11px; color: #9ca3af; font-weight: normal; margin-left: 8px; }

/* Tablo ve Ä°Ã§erik */
.user-card-content { 
    max-height: 0; 
    overflow: hidden; 
    transition: max-height 0.3s ease-out; 
}
.user-card-content.open { 
    max-height: 1000px; 
    border-top: 1px solid #e5e7eb; 
}

.server-table { width: 100%; border-collapse: collapse; }
.server-table th { 
    background: #f3f4f6; 
    padding: 10px; 
    font-size: 12px; 
    text-transform: uppercase; 
    color: #4b5563;
    border-bottom: 1px solid #e5e7eb;
}
.server-table td { 
    padding: 12px 10px; 
    text-align: center; 
    border-bottom: 1px solid #f3f4f6; 
    font-size: 14px;
}
/* Sunucu KartÄ± Ã–zel Stilleri */
.status-active { background: #dcfce7 !important; border-left: 5px solid #10b981; }
.status-passive { background: #fee2e2 !important; border-left: 5px solid #ef4444; }

.server-card-header {
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.admin-action-row {
    width: 100%;
    padding: 10px 0; /* Kenarlara tam yaslanmasÄ± iÃ§in saÄŸ-sol padding'i sÄ±fÄ±rladÄ±k */
    display: flex;
    justify-content: center; /* Butonu ortalar */
}

.btn-reset-all {
    background: #000000;
    color: white;
    border: none;
    padding: 15px 10px; /* Daha dolgun gÃ¶rÃ¼nmesi iÃ§in padding artÄ±rÄ±ldÄ± */
    border-radius: 8px; /* Panel kÃ¶ÅŸeleriyle uyumlu olsun diye biraz artÄ±rÄ±ldÄ± */
    font-weight: bold;
    cursor: pointer;
    font-size: 15px; /* YazÄ± boyutu biraz bÃ¼yÃ¼tÃ¼ldÃ¼ */
    transition: all 0.2s;
    width: 100%; /* Ä°Ã§inde bulunduÄŸu alan boyunca geniÅŸler */
    box-sizing: border-box; /* Padding'in geniÅŸliÄŸi bozmasÄ±nÄ± engeller */
}

.btn-reset-all:hover {
    background: #dc2626;
    transform: scale(0.99); /* TÄ±klama hissi iÃ§in hafif kÃ¼Ã§Ã¼lme efekti */
}
/* Loader Karartma Arka PlanÄ± */
#loader-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #f4f6f9; /* Sayfa arka plan rengiyle aynÄ± ve tam opak */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* En Ã¼stte durmasÄ± iÃ§in */
    opacity: 1;
    transition: opacity 0.4s ease;
}

.loader {
    width: 50px;
    aspect-ratio: 1;
    --_c: no-repeat radial-gradient(farthest-side, #690000 92%, #0000);
    background: 
        var(--_c) top,
        var(--_c) left,
        var(--_c) right,
        var(--_c) bottom;
    background-size: 12px 12px;
    animation: l7 1s infinite;
}

@keyframes l7 { to { transform: rotate(.5turn) } }

/* Loader gizlendiÄŸinde kullanÄ±lacak sÄ±nÄ±f */
.loader-hidden {
    opacity: 0;
    pointer-events: none;
}
/* Sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda iÃ§eriÄŸi tamamen gizliyoruz */
#content, #logout-area, #main-nav {
    visibility: hidden;
    opacity: 0;
}

/* Loader bittiÄŸinde bu sÄ±nÄ±fÄ± ekleyerek iÃ§eriÄŸi gÃ¶stereceÄŸiz */
.page-ready #content, 
.page-ready #logout-area, 
.page-ready #main-nav {
    visibility: visible;
    opacity: 1;
    transition: opacity 0.5s ease-in;
}

</style>
</head>
<body>
<div id="loader-overlay">
    <div class="loader"></div>
</div>
<header id="main-nav">
    <span class="active">Anasayfa</span>
    <span id="nav-cart" onclick="navTo('index.html')">Sepet</span>
    <span id="nav-msg" onclick="navTo('mesaj.html')">Mesajlar</span>
</header>
<div id="content">
    <div id="auth-box" class="auth-container">
        <h2>E-Ticaret 3.0</h2>
        <button id="login-nav-btn" class="btn-main login-toggle" onclick="togglePanel('login')">GiriÅŸ Yap</button>
        <p style="margin-top:10px; text-align: center; font-size:12px; color:#6b7280;">Hesap oluÅŸturmak iÃ§in sistem yÃ¶neticisine baÅŸvurunuz!</p>

        <div id="form-panel" class="expandable-panel">
            <input type="text" id="username" placeholder="Sicil NumarasÄ±" />
            <input type="password" id="password" placeholder="Åifre" />
            <button id="submit-btn" class="btn-main action-btn" onclick="handleAuth()">GÃ¶nder</button>
        </div>
        <div id="error"></div>
    </div>
<div id="content">
    <div id="welcome-msg" class="hidden" style="text-align: center;">
        <h3>HoÅŸ geldin, <span id="user-display" style="color:#940000"></span>!</h3>
    </div>

<div id="admin-main-container" class="hidden">
    
    <div class="admin-main-card">
        <div class="admin-main-header" onclick="toggleMainAdminPanel()">
            <span>ğŸ–¥ï¸ Bot YÃ¶netimi</span>
            <span id="main-chevron">â–¼</span>
        </div>
        <div id="admin-main-content" class="admin-main-content">
            <div id="admin-users-list"></div>
        </div>
    </div>

    <div class="admin-main-card">
        <div class="admin-main-header" onclick="toggleServerPanel()">
            <span>ğŸ–¥ï¸ Sunucu YÃ¶netimi</span>
            <span id="server-main-chevron">â–¼</span>
        </div>
        <div id="server-main-content" class="admin-main-content">
            <div class="admin-action-row">
                <button class="btn-reset-all" onclick="resetAllServers()">SunucularÄ± Yenile !</button>
				<button class="btn-reset-all" onclick="clearAllMessages()">TÃ¼m MesajlarÄ± Sil</button>
				<button class="btn-reset-all" onclick="clearAllLogs()">TÃ¼m LoglarÄ± Sil</button>
            </div>
            <div id="admin-server-list"></div>
        </div>
    </div>
    <div class="admin-main-card">
    <div class="admin-main-header" onclick="toggleLogsPanel()">
        <span>ğŸ“œ KullanÄ±cÄ± LoglarÄ±</span>
        <span id="logs-main-chevron">â–¼</span>
    </div>
    <div id="logs-main-content" class="admin-main-content">
        <div id="logs-list" style="background: #fff; color: #333; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
            HenÃ¼z ilgili log bulunamadÄ±...
        </div>
    </div>
</div>
<div id="admin-master-card" class="admin-main-card hidden">
    <div class="admin-main-header" onclick="toggleMasterPanel()">
        <span>ğŸ› ï¸ Sunucu LoglarÄ±</span>
        <span id="master-chevron">â–¼</span>
    </div>
    <div id="master-main-content" class="admin-main-content">
        <div id="master-list" style="background: #111; color: #0f0; padding: 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 11px; max-height: 400px; overflow-y: auto; border: 1px solid #333;">
            Sistem bekleniyor...
        </div>
    </div>
</div>
</div>
</div>
</div>
<div id="logout-area" style="flex-direction: column; align-items: center; gap: 10px;">
    <div id="action-area" class="hidden" style="text-align: center; padding: 15px; width: 100%; max-width: 320px;">
    </div>
    
    <button class="logout-btn" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap!</button>
</div>
<audio id="bing-sound" preload="auto">
    <source src="pop.wav" type="audio/wav">
</audio>
<script>
let isAdmin = false;
const firebaseUrl = "https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app/UserList";
let currentMode = '';
const baseDbUrl = "https://funforcanserver-default-rtdb.europe-west1.firebasedatabase.app";
let countdownInterval;
window.onload = async () => {
    // 1. Ã–nce oturum ve zamanlayÄ±cÄ± kontrollerini yap
    checkSession();
    checkTimer();
    
    // 2. Loader'Ä± kapat ve iÃ§eriÄŸi gÃ¶ster
    const loader = document.getElementById("loader-overlay");
    
    setTimeout(() => {
        // Body'ye hazÄ±r sÄ±nÄ±fÄ±nÄ± ekle (Ä°Ã§erik CSS ile gÃ¶rÃ¼nÃ¼r olacak)
        document.body.classList.add("page-ready");
        
        // Loader'Ä± yumuÅŸakÃ§a gizle
        loader.style.opacity = "0";
        
        setTimeout(() => {
            loader.style.display = "none";
        }, 400);
    }, 800); // 800ms bekleme sÃ¼resi (GÃ¶z yormayan bir geÃ§iÅŸ iÃ§in)
};
// Paneli AÃ§/Kapat
async function clearAllMessages() {
    // Sadece admin (197127) bu iÅŸlemi yapabilsin (gÃ¼venlik Ã¶nlemi)
    const currentUser = localStorage.getItem("user");
    if (currentUser !== "197127") {
        alert("Bu iÅŸlem iÃ§in yetkiniz yok!");
        return;
    }

    if (!confirm("TÃœM mesaj geÃ§miÅŸini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) return;

    try {
        const res = await fetch(`${baseDbUrl}/messages.json`, {
            method: 'DELETE'
        });

        if (res.ok) {
            alert("TÃ¼m mesajlar baÅŸarÄ±yla temizlendi.");
        } else {
            throw new Error("Silme iÅŸlemi baÅŸarÄ±sÄ±z.");
        }
    } catch (err) {
        console.error("Mesaj silme hatasÄ±:", err);
        alert("Mesajlar silinirken bir hata oluÅŸtu!");
    }
}
function toggleServerPanel() {
    const content = document.getElementById("server-main-content");
    const chevron = document.getElementById("server-main-chevron");
    const isOpen = content.classList.toggle("open");
    chevron.style.transform = isOpen ? "rotate(180deg)" : "rotate(0deg)";
}
async function resetAllServers() {
    if (!confirm("TÃ¼m sunucularÄ±n Ã§alÄ±ÅŸma ve baÄŸlantÄ± durumlarÄ±nÄ± pasife almak istediÄŸinize emin misiniz?")) return;

    try {
        // 1. Mevcut sunucu listesini Ã§ek
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        
        if (!serverData) return;

        const updates = {};
        // 2. Her cihaz iÃ§in gÃ¼ncellenecek alanlarÄ± belirle
        for (let deviceId in serverData) {
            updates[`${deviceId}/Active`] = false;
            updates[`${deviceId}/Server`] = false;
            updates[`${deviceId}/Status`] = false;
        }

        // 3. Toplu gÃ¼ncelleme gÃ¶nder (PATCH)
        const patchRes = await fetch(`${baseDbUrl}/ServerList.json`, {
            method: 'PATCH',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updates)
        });

        if (patchRes.ok) {
            alert("TÃ¼m sistemler baÅŸarÄ±yla durduruldu.");
            renderServerManagement(); // Listeyi yenile
        } else {
            throw new Error("GÃ¼ncelleme baÅŸarÄ±sÄ±z");
        }
    } catch (err) {
        console.error("Reset hatasÄ±:", err);
        alert("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu!");
    }
}
// Sunucu YÃ¶netimini BaÅŸlat (VeritabanÄ±ndan Ã‡eker)
async function renderServerManagement() {
    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        const container = document.getElementById("admin-server-list");
        if (!container) return;
        container.innerHTML = "";

for (let deviceId in serverData) {
    const server = serverData[deviceId];
    const isOnline = server.Status === true; 
    const serverName = deviceId.replace("Device", "Server ");

    const card = document.createElement("div");
    card.className = `user-admin-card ${isOnline ? 'status-active' : 'status-passive'}`;

    card.innerHTML = `
        <div class="server-card-header" onclick="toggleSubPanel('${deviceId}')">
            <div>
                <span class="status-dot" style="background:${isOnline ? '#10b981' : '#ef4444'}"></span>
                <b style="color:#111827">${serverName}</b>
            </div>
            <span id="chev-${deviceId}">â–¶</span>
        </div>
        <div id="content-${deviceId}" class="user-card-content">
            <table class="server-table">
                <tbody>
                    <tr>
                        <td style="text-align:left; padding-left:15px; color: black; font-weight: bold;">SUNUCU DURUMU : </td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" ${server.Server ? "checked" : ""} 
                                       onchange="updateServerConfig('${deviceId}', 'Server', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:left; padding-left:15px; color: black; font-weight: bold;">SUNUCU ERÄ°ÅÄ°MÄ° : </td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" ${server.Active ? "checked" : ""} 
                                       onchange="updateServerConfig('${deviceId}', 'Active', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    container.appendChild(card);
}
    } catch (err) {
        console.error("Sunucu listesi hatasÄ±:", err);
    }
}

// Alt panelleri tek tek aÃ§ma
function toggleSubPanel(id) {
    const content = document.getElementById(`content-${id}`);
    const chev = document.getElementById(`chev-${id}`);
    const isOpen = content.classList.toggle("open");
    chev.style.transform = isOpen ? "rotate(90deg)" : "rotate(0deg)";
}

// Sunucu ayarlarÄ±nÄ± gÃ¼ncelleme (Active veya Server bool deÄŸerleri iÃ§in)
async function updateServerConfig(device, field, value) {
    try {
        await fetch(`${baseDbUrl}/ServerList/${device}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ [field]: value })
        });
    } catch (err) {
        alert("GÃ¼ncelleme baÅŸarÄ±sÄ±z!");
    }
}
function toggleMainAdminPanel() {
    const content = document.getElementById("admin-main-content");
    const chevron = document.getElementById("main-chevron");
    const isOpen = content.classList.toggle("open");
    
    chevron.innerText = isOpen ? "â–²" : "â–¼";
    chevron.style.transform = isOpen ? "rotate(180deg)" : "rotate(0deg)";
}
function checkSession() {
    const user = localStorage.getItem("user");
    if (user) {
        showLoggedInState(user);
    }
}

// Navigasyon fonksiyonu
function navTo(page) {
    if (localStorage.getItem("user")) {
        window.location.href = page;
    } else {
        document.getElementById("error").innerText = "LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!";
    }
}

function togglePanel(mode) {
    const panel = document.getElementById("form-panel");
    const submitBtn = document.getElementById("submit-btn");
    
    if (currentMode === mode && panel.classList.contains('open')) {
        panel.classList.remove('open');
        currentMode = '';
    } else {
        currentMode = mode;
        submitBtn.innerText = mode === 'login' ? 'GiriÅŸ Yap' : 'KaydÄ± Tamamla';
        panel.classList.add('open');
        document.getElementById("error").innerText = "";
    }
}

async function handleAuth() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const errorDiv = document.getElementById("error");

    if (!username || !password) {
        errorDiv.innerText = "TÃ¼m alanlarÄ± doldurun!";
        return;
    }

    try {
if (currentMode === 'login') {
    const res = await fetch(`${firebaseUrl}/${username}.json`);
    const userData = await res.json(); // dbPassword yerine userData diyelim

    if (userData === null) {
        errorDiv.innerText = "KullanÄ±cÄ± bulunamadÄ±!";
    } else if (userData.password !== password) { // .password ile kontrol et
        errorDiv.innerText = "Åifre hatalÄ±!";
    } else {
        loginSuccess(username);
    }
} else if (currentMode === 'register') {
    const checkRes = await fetch(`${firebaseUrl}/${username}.json`);
    const exists = await checkRes.json();

    if (exists !== null) {
        errorDiv.innerText = "Bu sicil zaten kayÄ±tlÄ±!";
        return;
    }

    const regRes = await fetch(`${firebaseUrl}/${username}.json`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            password: password,
            userColor: "#2563eb", 
            userTitle: username,  
            userMessageColor: "#111827"
        })
    }); // <--- BURADAKÄ° PARANTEZLERÄ° KAPATMAYI UNUTMA

    if (regRes.ok) loginSuccess(username);
}
    } catch (err) {
        errorDiv.innerText = "BaÄŸlantÄ± hatasÄ±!";
    }
}

function loginSuccess(username) {
    localStorage.setItem("user", username);
    showLoggedInState(username);
}

// GiriÅŸ baÅŸarÄ±sÄ±nÄ± kontrol eden fonksiyonu gÃ¼ncelle
// GiriÅŸ durumunu gÃ¶steren gÃ¼ncellenmiÅŸ fonksiyon
async function showLoggedInState(username) {
    isAdmin = (username === "197127");
    const userDisplay = document.getElementById("user-display");
    
    try {
        const res = await fetch(`${firebaseUrl}/${username}.json`);
        const userData = await res.json();
        userDisplay.innerText = (userData && userData.userTitle) ? userData.userTitle.slice(7) : username;
    } catch (err) {
        userDisplay.innerText = username;
    }

    // ArayÃ¼z gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼
    document.getElementById("action-area").classList.remove("hidden");
    document.getElementById("auth-box").classList.add("hidden");
    document.getElementById("welcome-msg").classList.remove("hidden");
    document.getElementById("logout-area").style.display = "flex";
    document.querySelectorAll("#main-nav span:not(#count)").forEach(span => span.classList.add("enabled"));

    const adminContainer = document.getElementById("admin-main-container");
    if(adminContainer) {
        adminContainer.classList.remove("hidden");
        if (isAdmin) {
    document.getElementById("admin-master-card").classList.remove("hidden");
    renderMasterLogs(); // Ä°lk yÃ¼klemede Ã§ek
}
        // Admin deÄŸilse Sunucu YÃ¶netimi kartÄ±nÄ± gizle
        const serverCard = document.querySelectorAll('.admin-main-card')[1];
        if (!isAdmin && serverCard) serverCard.style.display = "none";

        // ANLIK DÄ°NLEMEYÄ° BAÅLAT
        startRealtimeListeners();
    }
}

// VeritabanÄ±ndaki deÄŸiÅŸiklikleri anlÄ±k takip eden fonksiyon
function startRealtimeListeners() {
    const paths = ["UserList", "ServerList"];
    
    paths.forEach(path => {
        const eventSource = new EventSource(`${baseDbUrl}/${path}.json`);
        
eventSource.addEventListener('put', (e) => {
    renderAdminPanel();
    if (isAdmin) {
        renderServerManagement();
        renderMasterLogs(); // Admin panelini canlÄ± gÃ¼ncelle
    }
    renderLogs();
});

        eventSource.onerror = (err) => {
            eventSource.close();
            setTimeout(startRealtimeListeners, 5000);
        };
    });
}

async function renderAdminPanel() {
    try {
        const currentLoggedUser = localStorage.getItem("user");
        const [usersRes, serversRes] = await Promise.all([
            fetch(`${baseDbUrl}/UserList.json`),
            fetch(`${baseDbUrl}/ServerList.json`)
        ]);
        
        const allUsers = await usersRes.json();
        const serverData = await serversRes.json();
        const container = document.getElementById("admin-users-list");
        if(!container) return;

        const openPanels = Array.from(document.querySelectorAll('.user-card-content.open')).map(el => el.id);
        container.innerHTML = ""; 

        for (let userId in allUsers) {
            if (!isAdmin && userId !== currentLoggedUser) continue;

            const user = allUsers[userId];
            const userTitle = user.userTitle || userId;
            const contentId = `user-content-${userId}`;

            const card = document.createElement("div");
            card.className = "user-admin-card";
            const isInitiallyOpen = openPanels.includes(contentId);

            card.innerHTML = `
                <div class="user-card-header" onclick="toggleUserPanel('${userId}')">
                    <span class="chevron ${isInitiallyOpen ? 'open-icon' : ''}" id="chev-user-${userId}">â–¶</span>
                    <div class="user-info">
                        ${userTitle} <span class="user-id-tag">#${userId}</span>
                    </div>
                </div>
                <div id="${contentId}" class="user-card-content ${isInitiallyOpen ? 'open' : ''}">
                    <table class="server-table">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding-left:15px;">Sunucu</th>
                                <th>Tekli</th>
                                <th>Ã‡oklu</th>
                            </tr>
                        </thead>
                        <tbody id="body-${userId}"></tbody>
                    </table>
                </div>
				<p style="margin-top:10px; text-align: center; font-size:12px; color:#6b7280;">SunucularÄ±n eriÅŸime aÃ§Ä±lmasÄ± ve kapatÄ±lmasÄ± sistem saÄŸlÄ±ÄŸÄ± iÃ§in Admin kontrolÃ¼ndedir.</p>
            `;
            container.appendChild(card);

            const tbody = document.getElementById(`body-${userId}`);
            for (let deviceId in serverData) {
                const device = serverData[deviceId];
                const tekKey = `${userId}_tek`;
                const cokKey = `${userId}_cok`;
                
                // --- YENÄ° MANTIK ---
                // canUse: Admin ise her zaman true, deÄŸilse Active verisine baÄŸlÄ±
                const canUse = isAdmin || (device.Active === true);
                
                // isOnline: Sadece gÃ¶rsel simge iÃ§in Status verisine baÄŸlÄ±
                const isOnline = (device.Status === true); 

                const tr = document.createElement("tr");
                // EÄŸer Active false ise ve admin deÄŸilsek satÄ±rÄ± soluklaÅŸtÄ±r
                if(!canUse) tr.style.opacity = "0.4";

                tr.innerHTML = `
                    <td style="text-align:left; padding-left:15px; color:#374151; font-weight:500;">
                        <span style="color: ${isOnline ? '#10b981' : '#ef4444'}; margin-right: 5px;">
                            ${isOnline ? 'âœ”' : 'âœ–'}
                        </span> 
                        ${deviceId.replace("Device", "Server ")}
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" 
                                   ${(device.UserList && device.UserList[tekKey]) ? "checked" : ""} 
                                   ${!canUse ? "disabled" : ""}
                                   onchange="updateServerStatus('${deviceId}', '${tekKey}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" 
                                   ${(device.UserList && device.UserList[cokKey]) ? "checked" : ""} 
                                   ${!canUse ? "disabled" : ""}
                                   onchange="updateServerStatus('${deviceId}', '${cokKey}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
    } catch (err) { console.error("Panel yÃ¼kleme hatasÄ±:", err); }
}
function toggleUserPanel(userId) {
    const content = document.getElementById(`user-content-${userId}`);
    const chev = document.getElementById(`chev-user-${userId}`);
    if(content) {
        const isOpen = content.classList.toggle("open");
        if(chev) chev.style.transform = isOpen ? "rotate(90deg)" : "rotate(0deg)";
    }
}
// Tek bir global update fonksiyonu yeterlidir
async function updateServerStatus(device, key, value) {
    try {
        await fetch(`${baseDbUrl}/ServerList/${device}/UserList.json`, {
            method: 'PATCH',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ [key]: value })
        });
    } catch (err) {
        console.error("GÃ¼ncelleme hatasÄ±:", err);
        alert("VeritabanÄ± baÄŸlantÄ± hatasÄ±!");
    }
}

function logout() {
    localStorage.removeItem("user");
    location.reload();
}
async function handleResetAction() {
    const userId = localStorage.getItem("user");
    if (!userId) return;

    const btn = document.getElementById("reset-btn");
    
    try {
        // 1. basketData iÃ§indeki kullanÄ±cÄ±ya ait veriyi sil (DELETE)
        await fetch(`${baseDbUrl}/basketData/${userId}.json`, { method: 'DELETE' });

        // 2. UserList iÃ§indeki refresh deÄŸerini true yap (PATCH)
        await fetch(`${baseDbUrl}/UserList/${userId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ refresh: true })
        });

        // 3. ZamanlayÄ±cÄ±yÄ± baÅŸlat (60 saniye)
        startTimer(60);
      
    } catch (err) {
        console.error("Ä°ÅŸlem hatasÄ±:", err);
        alert("Bir hata oluÅŸtu.");
    }
}

function startTimer(seconds) {
    const expireTime = Date.now() + (seconds * 1000);
    localStorage.setItem("timerExpire", expireTime);
    runVisualTimer(expireTime);
}

function runVisualTimer(expireTime) {
    const btn = document.getElementById("reset-btn");
    const display = document.getElementById("timer-display");
    
    btn.disabled = true;
    btn.style.opacity = "0.5";
    btn.style.cursor = "not-allowed";

    clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = Math.max(0, Math.floor((expireTime - now) / 1000));

        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            display.innerText = "";
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            localStorage.removeItem("timerExpire");
        } else {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            display.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

function checkTimer() {
    const expireTime = localStorage.getItem("timerExpire");
    if (expireTime) {
        const now = Date.now();
        if (now < expireTime) {
            runVisualTimer(parseInt(expireTime));
        } else {
            localStorage.removeItem("timerExpire");
        }
    }
}
function toggleLogsPanel() {
    const content = document.getElementById("logs-main-content");
    const chevron = document.getElementById("logs-main-chevron");
    const isOpen = content.classList.toggle("open");
    
    chevron.style.transform = isOpen ? "rotate(180deg)" : "rotate(0deg)";
    
    // Panel ilk kez aÃ§Ä±lÄ±yorsa veya aÃ§Ä±ldÄ±ÄŸÄ±nda taze veri istiyorsak
    if(isOpen) {
        renderLogs(); 
    }
}

// LoglarÄ± Ã§ekme ve filtreleme fonksiyonu
let lastProcessedLog = ""; // Sayfa aÃ§Ä±kken son Ã§alÄ±nan sesi takip eder

async function renderLogs() {
    const container = document.getElementById("logs-list");
    const currentUserId = localStorage.getItem("user");
    const bingSound = document.getElementById("bing-sound");
    
    if (!currentUserId) return;

    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        let allLogs = []; 

        for (let deviceId in serverData) {
            const device = serverData[deviceId];
            if (device.logs) {
                Object.values(device.logs).forEach(logMessage => {
                    if (String(logMessage).includes(currentUserId)) {
                        let cleanedMessage = logMessage.replace(currentUserId + ":", "");
                        cleanedMessage = cleanedMessage.replace("(Uzaktan)", "").trim();
                        if (!cleanedMessage.endsWith(".")) cleanedMessage += ".";

                        const timePart = cleanedMessage.split(" : ")[0] || "00:00:00";

                        allLogs.push({
                            device: deviceId.replace("Device", "Server "),
                            message: cleanedMessage,
                            time: timePart,
                            raw: logMessage // Ses kontrolÃ¼ iÃ§in ham mesajÄ± tutalÄ±m
                        });
                    }
                });
            }
        }

        // Saate gÃ¶re sÄ±rala
        allLogs.sort((a, b) => b.time.localeCompare(a.time));

        // --- SES Ã‡ALMA MANTIÄI ---
        if (allLogs.length > 0) {
            const latestLog = allLogs[0]; // En yeni log (sÄ±ralandÄ±ÄŸÄ± iÃ§in)
            
            // EÄŸer en yeni log "Eklendi" iÃ§eriyorsa VE daha Ã¶nce bu mesaj iÃ§in ses Ã§alÄ±nmadÄ±ysa
            if (latestLog.message.includes("Eklendi") && lastProcessedLog !== latestLog.raw) {
                bingSound.play().catch(e => console.log("Ses Ã§alma engellendi: ", e));
                lastProcessedLog = latestLog.raw; // AynÄ± log iÃ§in tekrar Ã§almasÄ±n
            }
        }
        // -------------------------

        // ArayÃ¼zÃ¼ Ã§izdirme (Map kÄ±smÄ± aynÄ± kalÄ±yor)
        if (allLogs.length > 0) {
            container.innerHTML = allLogs.map(log => {
                const parts = log.message.split(" : ");
                const timeDisplay = parts[0] || "";
                const actionPart = parts[1] || log.message;

                let actionBgColor = "#ffffff"; 
                if (actionPart.includes("EtkisizleÅŸtirildi")) actionBgColor = "#FF5454";
                else if (actionPart.includes("EtkinleÅŸtirildi")) actionBgColor = "#73FF7A";
                else if (actionPart.includes("Eklendi")) actionBgColor = "#00FFFF";

                return `
                    <div style="margin-bottom: 10px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd;">
                        <div style="background-color: #690000; color: white; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center;">
                            <b style="font-size: 11px; text-transform: uppercase;">${log.device}</b>
                            <span style="font-size: 10px; opacity: 0.9; font-weight: bold;">${timeDisplay}</span>
                        </div>
                        <div style="background-color: ${actionBgColor}; padding: 12px; color: #000; font-size: 13px; font-weight: 600;">
                            ${actionPart}
                        </div>
                    </div>
                `;
            }).join("");
        } else {
            container.innerHTML = "<div style='color:#333; text-align:center; padding:20px;'>KayÄ±t bulunamadÄ±.</div>";
        }
        
    } catch (err) {
        console.error("Log hatasÄ±:", err);
    }
}
// Master Paneli AÃ§/Kapat
function toggleMasterPanel() {
    const content = document.getElementById("master-main-content");
    const chevron = document.getElementById("master-chevron");
    const isOpen = content.classList.toggle("open");
    chevron.style.transform = isOpen ? "rotate(180deg)" : "rotate(0deg)";
    if(isOpen) renderMasterLogs();
}

async function renderMasterLogs() {
    // Sadece admin (197127) ise Ã§alÄ±ÅŸtÄ±r
    if (localStorage.getItem("user") !== "197127") return;

    const container = document.getElementById("master-list");
    try {
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        let allMasterLogs = [];

        for (let deviceId in serverData) {
            const device = serverData[deviceId];
            if (device.logs) {
                Object.values(device.logs).forEach(logMsg => {
                    // 1. Saati ayÄ±klayalÄ±m (BaÅŸtaki [Saat] iÃ§in)
                    const timePart = String(logMsg).split(" : ")[0] || "00:00:00";
                    
                    // 2. Mesaj iÃ§eriÄŸini temizleyelim (ID'yi koruyarak)
                    // BaÅŸtaki saati ve " : " kÄ±smÄ±nÄ± atÄ±yoruz
                    let cleanContent = String(logMsg).includes(" : ") ? String(logMsg).split(" : ").slice(1).join(" : ") : logMsg;
                    
                    // "(Uzaktan)" yazÄ±sÄ±nÄ± silelim
                    cleanContent = cleanContent.replace("(Uzaktan)", "").trim();
                    
                    allMasterLogs.push({
                        device: deviceId.replace("Device", "Server "), // S2 yerine Server 2
                        content: cleanContent,
                        time: timePart
                    });
                });
            }
        }

        // Saate gÃ¶re sÄ±rala (En yeni en Ã¼stte)
        allMasterLogs.sort((a, b) => b.time.localeCompare(a.time));

        // Ekrana yazdÄ±r (BaÅŸlÄ±k ÅŸeridi eklenmiÅŸ format)
        container.innerHTML = allMasterLogs.map(log => `
            <div style="margin-bottom: 8px; border-left: 3px solid #690000; background: #1a1a1a; border-radius: 4px; overflow: hidden;">
                <div style="background: #2a2a2a; padding: 4px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
                    <b style="color: #ff4444; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">${log.device}</b>
                    <span style="color: #888; font-size: 10px; font-weight: bold;">[${log.time}]</span>
                </div>
                <div style="padding: 8px 10px; color: #0f0; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
                    ${log.content}
                </div>
            </div>
        `).join("");

    } catch (err) { 
        console.error("Master log hatasÄ±:", err); 
    }
}
async function clearAllLogs() {
    // Sadece admin (197127) yetkisine sahip mi kontrol et
    const currentUser = localStorage.getItem("user");
    if (currentUser !== "197127") {
        alert("Bu iÅŸlem iÃ§in yetkiniz yok!");
        return;
    }

    if (!confirm("TÃœM sunuculardaki log geÃ§miÅŸini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) return;

    try {
        // 1. Ã–nce mevcut sunucu listesini alalÄ±m
        const res = await fetch(`${baseDbUrl}/ServerList.json`);
        const serverData = await res.json();
        
        if (!serverData) return;

        const updates = {};
        // 2. Her cihazÄ±n altÄ±ndaki 'logs' kÄ±smÄ±nÄ± null (boÅŸ) olarak iÅŸaretle
        for (let deviceId in serverData) {
            updates[`${deviceId}/logs`] = null;
        }

        // 3. Tek bir PATCH isteÄŸi ile tÃ¼m loglarÄ± temizle
        const patchRes = await fetch(`${baseDbUrl}/ServerList.json`, {
            method: 'PATCH',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updates)
        });

        if (patchRes.ok) {
            alert("TÃ¼m sistem loglarÄ± baÅŸarÄ±yla temizlendi.");
            // Ekrandaki listeleri de anÄ±nda boÅŸaltalÄ±m
            document.getElementById("logs-list").innerHTML = "Loglar temizlendi.";
            if(document.getElementById("master-list")) {
                document.getElementById("master-list").innerHTML = "Sistem temizlendi.";
            }
        } else {
            throw new Error("Silme iÅŸlemi baÅŸarÄ±sÄ±z.");
        }
    } catch (err) {
        console.error("Log silme hatasÄ±:", err);
        alert("Loglar silinirken bir hata oluÅŸtu!");
    }
}
</script>

</body>
</html>